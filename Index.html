# Index-html
https://github.com/Book7 MVP -debug/vite.git
import { useState, useEffect, useCallback } from "react";
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { 
  getFirestore, collection, query, onSnapshot, addDoc, doc, updateDoc,
  serverTimestamp, setLogLevel, orderBy, deleteField, limit
} from 'firebase/firestore';
import {
  Clock, TrendingUp, TrendingDown, Users, DollarSign, Calendar, Zap, RefreshCw, AlertTriangle
} from 'lucide-react';

// Configuration check for Firebase globals
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined'
  ? JSON.parse(__firebase_config)
  : {};

export default function Book7App() {
  // === Firebase State & Setup ===
  const [db, setDb] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);

  // === App State ===
  const [activeTab, setActiveTab] = useState("ledger");
  const [transactions, setTransactions] = useState([]);
  const [debtsOwe, setDebtsOwe] = useState([]); // Debts the user owes to others
  const [debtsReceive, setDebtsReceive] = useState([]); // Debts owed to the user
  
  // === AI Analysis State ===
  const [aiAnalysisResult, setAiAnalysisResult] = useState(null);
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [aiError, setAiError] = useState(null);

  // === Form States ===
  const [transactionForm, setTransactionForm] = useState({
    date: new Date().toISOString().substring(0, 10),
    business: "",
    category: "Sale",
    description: "",
    inflow: "",
    outflow: "",
    method: "Cash",
  });
  
  const [debtForm, setDebtForm] = useState({
    name: "",
    amount: "",
    dueDate: "",
    type: "owe", // 'owe' or 'receive'
  });

  // --- Calculations ---
  const totalIn = transactions.reduce((a, b) => a + Number(b.inflow || 0), 0);
  const totalOut = transactions.reduce((a, b) => a + Number(b.outflow || 0), 0);
  const net = totalIn - totalOut;
  const unsettledOwe = debtsOwe.filter(d => !d.isSettled).reduce((sum, d) => sum + d.amount, 0);
  const unsettledReceive = debtsReceive.filter(d => !d.isSettled).reduce((sum, d) => sum + d.amount, 0);


  // 1. Firebase Initialization and Authentication
  useEffect(() => {
    try {
      // Set log level for debugging
      setLogLevel('Debug');
      
      const app = initializeApp(firebaseConfig);
      const firestoreDb = getFirestore(app);
      const authInstance = getAuth(app);

      setDb(firestoreDb);

      // Handle custom token sign-in first
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        signInWithCustomToken(authInstance, __initial_auth_token)
          .catch(e => {
            console.error("Custom token sign-in failed. Falling back to anonymous.", e);
            signInAnonymously(authInstance).catch(console.error);
          });
      } else {
        // Sign in anonymously if no token is available
        signInAnonymously(authInstance).catch(console.error);
      }

      // Auth state listener: sets userId and marks auth as ready
      const unsubscribeAuth = onAuthStateChanged(authInstance, (user) => {
        if (user) {
          setUserId(user.uid);
        } else {
          setUserId(null); 
        }
        setIsAuthReady(true);
      });

      return () => unsubscribeAuth();

    } catch (e) {
      console.error("Firebase Initialization Error:", e);
    }
  }, []); 

  // 2. Firestore Data Listeners (Real-time sync)
  useEffect(() => {
    // Guard clause: Do not run queries until Firebase is initialized and user is authenticated
    if (!db || !userId || !isAuthReady) return;

    const txCollectionPath = `artifacts/${appId}/users/${userId}/book7_transactions`;
    const debtCollectionPath = `artifacts/${appId}/users/${userId}/book7_debts`;

    // --- Listener for Transactions ---
    const txQuery = query(
      collection(db, txCollectionPath), 
      orderBy('createdAt', 'desc'), 
      limit(100)
    );
    const unsubscribeTx = onSnapshot(txQuery, (snapshot) => {
      const txData = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        inflow: Number(doc.data().inflow || 0),
        outflow: Number(doc.data().outflow || 0),
      }));
      setTransactions(txData);
    }, (error) => console.error("Transaction Snapshot Error:", error));

    // --- Listener for Debts ---
    const debtQuery = query(
      collection(db, debtCollectionPath), 
      orderBy('dueDate', 'asc')
    );
    const unsubscribeDebt = onSnapshot(debtQuery, (snapshot) => {
      const debtData = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setDebtsOwe(debtData.filter(d => d.type === 'owe'));
      setDebtsReceive(debtData.filter(d => d.type === 'receive'));
    }, (error) => console.error("Debt Snapshot Error:", error));

    // Cleanup function
    return () => {
      unsubscribeTx();
      unsubscribeDebt();
    };

  }, [db, userId, isAuthReady]); 

  // --- Transaction Logic ---
  const addTransaction = async () => {
    if (!db || !userId || !isAuthReady) return;
    if (!transactionForm.date || (!transactionForm.inflow && !transactionForm.outflow)) return;

    const transactionData = {
      date: transactionForm.date,
      business: transactionForm.business || 'N/A',
      category: transactionForm.category,
      description: transactionForm.description || '',
      inflow: Number(transactionForm.inflow || 0),
      outflow: Number(transactionForm.outflow || 0),
      method: transactionForm.method,
      createdAt: serverTimestamp(),
    };

    try {
      const txCollectionPath = `artifacts/${appId}/users/${userId}/book7_transactions`;
      await addDoc(collection(db, txCollectionPath), transactionData);

      setTransactionForm({ date: new Date().toISOString().substring(0, 10), business: "", category: "Sale", description: "", inflow: "", outflow: "", method: "Cash" });
    } catch (e) {
      console.error("Error adding transaction: ", e);
    }
  };

  // --- Debt Logic ---
  const addDebt = async (e) => {
    e.preventDefault();
    if (!db || !userId || !isAuthReady) return;
    if (!debtForm.name || !debtForm.amount || !debtForm.dueDate) return;

    const debtData = {
      name: debtForm.name,
      amount: Number(debtForm.amount),
      dueDate: debtForm.dueDate,
      type: debtForm.type, 
      isSettled: false,
      createdAt: serverTimestamp(),
    };

    try {
      const debtCollectionPath = `artifacts/${appId}/users/${userId}/book7_debts`;
      await addDoc(collection(db, debtCollectionPath), debtData);

      setDebtForm({ name: "", amount: "", dueDate: "", type: debtForm.type });
    } catch (e) {
      console.error("Error adding debt: ", e);
    }
  };

  const toggleDebtSettled = async (id, currentStatus) => {
    if (!db || !userId || !isAuthReady) return;

    try {
      const debtCollectionPath = `artifacts/${appId}/users/${userId}/book7_debts`;
      const debtRef = doc(db, debtCollectionPath, id);
      
      const updateData = {
        isSettled: !currentStatus,
      };

      if (!currentStatus) {
        updateData.settledAt = serverTimestamp();
      } else {
        updateData.settledAt = deleteField();
      }

      await updateDoc(debtRef, updateData);
    } catch (e) {
      console.error("Error updating debt: ", e);
    }
  };
  
  // --- AI Analysis Function ---
  const fetchAiAnalysis = useCallback(async () => {
    if (isAiLoading) return;
    
    setIsAiLoading(true);
    setAiError(null);
    setAiAnalysisResult(null);

    const systemPrompt = "You are a world-class financial analyst specializing in small business operations. Analyze the provided financial data. Your response must be in Markdown format, highly actionable, and focus on two sections: 1) Profit Leak Analysis (where money might be wasted or lost), and 2) Strategic Growth Ideas (concrete steps to increase next week's profit). Keep the entire analysis concise, professional, and less than 300 words.";
    
    const userQuery = `Analyze the following business financial data:
    - Total Inflow (Revenue): Ksh ${totalIn.toLocaleString()}
    - Total Outflow (Expenses): Ksh ${totalOut.toLocaleString()}
    - Net Profit: Ksh ${net.toLocaleString()}
    
    Provide an analysis based on this data.`;

    const apiKey = ""; 
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
    };

    const maxRetries = 3;
    let attempt = 0;

    while (attempt < maxRetries) {
      try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`API call failed with status: ${response.status}`);
        }

        const result = await response.json();
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (text) {
          setAiAnalysisResult(text);
          setAiError(null);
          return; // Exit function on success
        } else {
          throw new Error("Received empty or malformed response from AI.");
        }
      } catch (error) {
        attempt++;
        if (attempt >= maxRetries) {
          console.error("Failed to fetch AI analysis after multiple retries:", error);
          setAiError("Could not generate analysis. Please try again.");
          break; // Exit loop if max retries reached
        }
        // Exponential backoff
        const delay = Math.pow(2, attempt) * 1000;
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
    setIsAiLoading(false);
  }, [totalIn, totalOut, net, isAiLoading]);

  // --- Helper Components ---
  const LoadingIndicator = () => (
    <div className="flex items-center justify-center p-8 text-gray-500">
        <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Loading Data...
    </div>
  );

  const DebtItem = ({ debt, onToggleSettled, isOwe }) => {
    const isOverdue = !debt.isSettled && debt.dueDate && new Date(debt.dueDate) < new Date();
    return (
      <div 
        className={`flex justify-between items-center p-3 rounded-xl shadow-sm text-sm transition-all 
          ${debt.isSettled ? 'bg-green-50 text-gray-500 line-through' : 
          isOverdue ? 'bg-red-100 border border-red-300' : 'bg-white border border-gray-200'} cursor-pointer`}
        onClick={() => onToggleSettled(debt.id, debt.isSettled)}
      >
        <div className="flex-1 min-w-0">
          <p className="font-semibold truncate">{debt.name}</p>
          <p className="text-xs text-gray-500 flex items-center gap-1">
            <Calendar size={12} /> 
            Due: {debt.dueDate}
            {isOverdue && <span className="text-red-600 font-bold ml-1"> (OVERDUE)</span>}
          </p>
        </div>
        <div className={`font-bold ml-4 text-right ${isOwe ? 'text-red-500' : 'text-green-500'}`}>
          Ksh {debt.amount.toLocaleString()}
          <span className="block text-xs font-normal">
            {debt.isSettled ? "Settled" : "Pending"}
          </span>
        </div>
      </div>
    );
  };
  
  if (!isAuthReady) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <LoadingIndicator />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 p-4 font-sans">
      <div className="bg-white rounded-2xl shadow-lg p-4 mb-4 text-center">
        <h1 className="text-2xl font-extrabold text-gray-900">Book 7 Ledger</h1>
        <p className="text-xs text-gray-500">User ID: {userId}</p>
      </div>

      <div className="flex justify-between mb-4 bg-white p-2 rounded-xl shadow-md">
        {["ledger", "debts", "calendar", "summary"].map((tab) => (
          <button
            key={tab}
            onClick={() => setActiveTab(tab)}
            className={`flex-1 py-2 capitalize rounded-lg text-sm font-semibold transition-colors duration-200 ${
              activeTab === tab
                ? "bg-indigo-600 text-white shadow-lg"
                : "text-gray-600 hover:bg-gray-100"
            }`}
          >
            {tab}
          </button>
        ))}
      </div>

      <div className="pb-8"> 
        {/* === LEDGER TAB === (Previous content) */}
        {activeTab === "ledger" && (
          <div className="space-y-4">
            <div className="bg-white p-4 rounded-2xl shadow-lg border border-gray-100">
              <h2 className="font-bold text-lg mb-3 flex items-center gap-2 text-indigo-700">
                <Clock size={18}/> New Transaction
              </h2>
              <div className="grid grid-cols-2 gap-3 mb-4">
                <input 
                  type="date" 
                  className="border p-3 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 text-sm" 
                  value={transactionForm.date} 
                  onChange={e => setTransactionForm({ ...transactionForm, date: e.target.value })} 
                />
                <select 
                  className="border p-3 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 text-sm" 
                  value={transactionForm.category} 
                  onChange={e => setTransactionForm({ ...transactionForm, category: e.target.value })}
                >
                  <option value="Sale">Sale (Income)</option>
                  <option value="Expense">Expense (Cost)</option>
                  <option value="Stock">Inventory/Stock</option>
                  <option value="Salary">Salary/Wages</option>
                  <option value="Transfer">Transfer</option>
                </select>
                <input 
                  placeholder="Business/Contact" 
                  className="border p-3 rounded-xl col-span-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" 
                  value={transactionForm.business} 
                  onChange={e => setTransactionForm({ ...transactionForm, business: e.target.value })} 
                />
                <input 
                  type="number" 
                  placeholder="Inflow (Ksh)" 
                  className="border p-3 rounded-xl focus:ring-green-500 focus:border-green-500 text-sm" 
                  value={transactionForm.inflow} 
                  onChange={e => setTransactionForm({ ...transactionForm, inflow: e.target.value, outflow: "" })} 
                />
                <input 
                  type="number" 
                  placeholder="Outflow (Ksh)" 
                  className="border p-3 rounded-xl focus:ring-red-500 focus:border-red-500 text-sm" 
                  value={transactionForm.outflow} 
                  onChange={e => setTransactionForm({ ...transactionForm, outflow: e.target.value, inflow: "" })} 
                />
                <input 
                  placeholder="Description (e.g., 'Coffee beans purchase')" 
                  className="border p-3 rounded-xl col-span-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" 
                  value={transactionForm.description} 
                  onChange={e => setTransactionForm({ ...transactionForm, description: e.target.value })} 
                />
              </div>
              <button 
                onClick={addTransaction} 
                className="w-full bg-indigo-600 text-white p-3 rounded-xl font-bold hover:bg-indigo-700 transition-colors shadow-md"
                disabled={!isAuthReady}
              >
                Save Transaction
              </button>
            </div>

            <div className="bg-white p-4 rounded-2xl shadow-lg border border-gray-100">
                <h3 className="font-bold text-lg mb-3 flex items-center gap-2 text-gray-700"><DollarSign size={18}/> Financial Overview</h3>
                <div className="grid grid-cols-3 text-center gap-2">
                    <div className="bg-green-50 p-3 rounded-xl">
                        <p className="text-xs text-gray-500 font-medium flex items-center justify-center gap-1"><TrendingUp size={12}/> INFLOW</p>
                        <p className="font-bold text-green-700">Ksh {totalIn.toLocaleString()}</p>
                    </div>
                    <div className="bg-red-50 p-3 rounded-xl">
                        <p className="text-xs text-gray-500 font-medium flex items-center justify-center gap-1"><TrendingDown size={12}/> OUTFLOW</p>
                        <p className="font-bold text-red-700">Ksh {totalOut.toLocaleString()}</p>
                    </div>
                    <div className={`p-3 rounded-xl ${net >= 0 ? 'bg-indigo-100 text-indigo-700' : 'bg-pink-100 text-pink-700'}`}>
                        <p className="text-xs text-gray-600 font-medium">NET BALANCE</p>
                        <p className="font-bold">Ksh {net.toLocaleString()}</p>
                    </div>
                </div>
            </div>

            <div className="bg-white p-4 rounded-2xl shadow-lg border border-gray-100">
                <h3 className="font-bold text-lg mb-3 text-gray-700">Recent Transactions</h3>
                <div className="space-y-2">
                    {transactions.length > 0 ? (
                        transactions.slice(0, 10).map(t => (
                            <div key={t.id} className="border p-3 rounded-xl text-xs bg-gray-50 shadow-sm flex justify-between items-center">
                                <div className="flex-1 min-w-0">
                                    <p className="font-bold truncate">{t.date} - {t.business || 'N/A'}</p>
                                    <p className="text-gray-500 truncate">{t.description || t.category}</p>
                                </div>
                                <div className={`ml-4 font-semibold text-right ${t.inflow > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    {t.inflow > 0 ? `+Ksh ${t.inflow.toLocaleString()}` : `-Ksh ${t.outflow.toLocaleString()}`}
                                </div>
                            </div>
                        ))
                    ) : (
                        <p className="text-gray-500 text-sm italic">No transactions recorded yet. Start logging!</p>
                    )}
                </div>
            </div>
          </div>
        )}

        {/* === DEBTS TAB === (Previous content) */}
        {activeTab === "debts" && (
          <div className="space-y-4">
            <div className="bg-white p-4 rounded-2xl shadow-lg border border-gray-100">
                <h2 className="font-bold text-lg mb-3 flex items-center gap-2 text-indigo-700">
                  <Users size={18}/> Manage Debts
                </h2>
                <form onSubmit={addDebt} className="space-y-3">
                    <div className="grid grid-cols-2 gap-3">
                      <select 
                        className="border p-3 rounded-xl text-sm" 
                        value={debtForm.type} 
                        onChange={e => setDebtForm({ ...debtForm, type: e.target.value })}
                      >
                        <option value="owe">Debt I Owe</option>
                        <option value="receive">Debt Owed To Me</option>
                      </select>
                      <input 
                        type="date" 
                        placeholder="Due Date" 
                        className="border p-3 rounded-xl text-sm" 
                        value={debtForm.dueDate} 
                        onChange={e => setDebtForm({ ...debtForm, dueDate: e.target.value })} 
                        required
                      />
                    </div>
                    <input 
                        placeholder="Person/Company Name" 
                        className="border p-3 rounded-xl w-full text-sm" 
                        value={debtForm.name} 
                        onChange={e => setDebtForm({ ...debtForm, name: e.target.value })} 
                        required
                      />
                    <input 
                        type="number" 
                        placeholder="Amount (Ksh)" 
                        className="border p-3 rounded-xl w-full text-sm" 
                        value={debtForm.amount} 
                        onChange={e => setDebtForm({ ...debtForm, amount: e.target.value })} 
                        required
                      />
                    <button type="submit" className="w-full bg-indigo-600 text-white p-3 rounded-xl font-bold hover:bg-indigo-700 transition-colors shadow-md">
                        Add Debt
                    </button>
                </form>
            </div>

            <div className="space-y-4">
              <div className="p-4 rounded-2xl bg-white shadow-lg border border-gray-100">
                <h3 className="font-bold text-lg mb-2 text-red-600">Debts You Owe (Ksh {unsettledOwe.toLocaleString()})</h3>
                <p className="text-xs text-gray-500 mb-3">Tap to mark as settled/pending.</p>
                <div className="space-y-2">
                  {debtsOwe.length > 0 ? debtsOwe.map(d => (
                    <DebtItem key={d.id} debt={d} onToggleSettled={toggleDebtSettled} isOwe={true} />
                  )) : <p className="text-gray-500 text-sm italic">No debts currently owed by you.</p>}
                </div>
              </div>
              
              <div className="p-4 rounded-2xl bg-white shadow-lg border border-gray-100">
                <h3 className="font-bold text-lg mb-2 text-green-600">Debts Owed To You (Ksh {unsettledReceive.toLocaleString()})</h3>
                <p className="text-xs text-gray-500 mb-3">Tap to mark as settled/pending.</p>
                <div className="space-y-2">
                  {debtsReceive.length > 0 ? debtsReceive.map(d => (
                    <DebtItem key={d.id} debt={d} onToggleSettled={toggleDebtSettled} isOwe={false} />
                  )) : <p className="text-gray-500 text-sm italic">No debts currently owed to you.</p>}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* === CALENDAR TAB (Previous content) */}
        {activeTab === "calendar" && (
          <div className="bg-white p-4 rounded-2xl shadow-lg border border-gray-100">
            <h2 className="font-bold text-xl mb-2 flex items-center gap-2 text-gray-700"><Calendar size={20}/> Important Dates</h2>
            <p className="text-sm text-gray-500 mb-4">
              This tab highlights upcoming deadlines, especially debt due dates.
            </p>
            <div className="space-y-2">
                {debtsOwe.filter(d => !d.isSettled).map(d => (
                    <div key={d.id} className={`p-3 rounded-xl text-sm ${new Date(d.dueDate) < new Date() ? 'bg-red-100' : 'bg-yellow-100'}`}>
                        <p className="font-semibold text-red-800">PAY: {d.name}</p>
                        <p className="text-xs">Ksh {d.amount.toLocaleString()} due on <span className="font-bold">{d.dueDate}</span></p>
                    </div>
                ))}
                 {debtsReceive.filter(d => !d.isSettled).map(d => (
                    <div key={d.id} className={`p-3 rounded-xl text-sm ${new Date(d.dueDate) < new Date() ? 'bg-red-100' : 'bg-green-100'}`}>
                        <p className="font-semibold text-green-800">RECEIVE: {d.name}</p>
                        <p className="text-xs">Ksh {d.amount.toLocaleString()} due on <span className="font-bold">{d.dueDate}</span></p>
                    </div>
                ))}
                {debtsOwe.filter(d => !d.isSettled).length === 0 && debtsReceive.filter(d => !d.isSettled).length === 0 && (
                     <p className="text-gray-500 text-sm italic">No active debts to display.</p>
                )}
            </div>
          </div>
        )}

        {/* === SUMMARY TAB (Updated for AI) === */}
        {activeTab === "summary" && (
          <div className="space-y-4">
            <div className="bg-white p-4 rounded-2xl shadow-lg border border-gray-100">
              <h2 className="font-bold text-xl mb-3 text-gray-700">Business Summary</h2>
              <div className="space-y-2 text-sm">
                <p>Total Transactions: <b className="text-indigo-600">{transactions.length}</b></p>
                <p>Total Inflow: <b className="text-green-600">Ksh {totalIn.toLocaleString()}</b></p>
                <p>Total Outflow: <b className="text-red-600">Ksh {totalOut.toLocaleString()}</b></p>
                <p className="font-bold text-lg pt-2 border-t mt-2">Net Profit: Ksh {net.toLocaleString()}</p>
              </div>
            </div>

            <div className="bg-indigo-50 p-4 rounded-2xl shadow-lg border border-indigo-300">
              <h3 className="font-bold text-lg mb-3 text-indigo-800 flex items-center gap-2"><Zap size={20}/> AI Financial Analysis</h3>
              
              <button 
                onClick={fetchAiAnalysis} 
                disabled={isAiLoading || transactions.length === 0}
                className="w-full bg-indigo-600 text-white p-3 rounded-xl font-bold hover:bg-indigo-700 transition-colors shadow-md flex items-center justify-center disabled:bg-indigo-400"
              >
                {isAiLoading ? (
                  <>
                    <RefreshCw size={16} className="animate-spin mr-2"/> Analyzing...
                  </>
                ) : transactions.length === 0 ? (
                  "Add Transactions to Analyze"
                ) : (
                  "Run Analysis"
                )}
              </button>

              {aiError && (
                <div className="mt-3 p-3 bg-red-100 text-red-700 rounded-xl text-sm flex items-center gap-2">
                  <AlertTriangle size={16} /> {aiError}
                </div>
              )}

              {aiAnalysisResult && (
                <div className="mt-4 p-3 bg-white rounded-xl shadow-inner border border-gray-200 text-sm">
                  <h4 className="font-bold text-md mb-2 text-indigo-700">Expert Report:</h4>
                  {/* Dangerously set inner HTML for Markdown rendering */}
                  <div 
                    className="prose prose-sm max-w-none" 
                    dangerouslySetInnerHTML={{ __html: aiAnalysisResult }}
                  />
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}


