<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>BookPesa — Offline-first (Dexie) — Supabase Optional</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/dexie@3/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0F766E" />
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .no-scrollbar::-webkit-scrollbar { display:none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .tab-anim { animation: fadeIn .22s ease-out both; } @keyframes fadeIn { from { opacity:0; transform:translateY(6px) } to { opacity:1; transform:translateY(0) } }
    .install-btn { background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.08); }
  </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">
  <header class="bg-gradient-to-r from-emerald-600 to-teal-700 text-white p-3 shadow-sm">
    <div class="max-w-3xl mx-auto flex items-center gap-4">
      <div class="rounded-lg bg-white/10 px-3 py-2 font-bold">BookPesa</div>
      <div class="flex-1 text-sm opacity-90">Offline-first ledger • Optional cloud sync (Supabase)</div>
      <div class="flex items-center gap-2">
        <button id="downloadIconsBtn" class="text-xs px-2 py-1 rounded install-btn">Download Icons</button>
        <button id="installBtn" class="text-xs px-3 py-1 rounded install-btn hidden">Install App</button>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto p-4">
    <!-- Quick Journal + Totals -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <div class="md:col-span-2 bg-white rounded-2xl p-4 shadow-sm">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-bold">Quick Journal</h2>
          <div class="text-xs text-slate-400">Rapid entries</div>
        </div>
        <div class="flex gap-2">
          <input id="quickAmount" type="number" placeholder="Amount (KES)" class="flex-1 px-3 py-2 rounded-lg border bg-slate-50 outline-none" />
          <input id="quickNote" type="text" placeholder="Note (optional)" class="px-3 py-2 rounded-lg border bg-slate-50 outline-none w-44" />
          <button id="cashInBtn" class="px-3 py-2 rounded-lg bg-emerald-600 text-white font-bold">Cash In</button>
          <button id="cashOutBtn" class="px-3 py-2 rounded-lg bg-rose-500 text-white font-bold">Cash Out</button>
        </div>
      </div>

      <div class="bg-white rounded-2xl p-4 shadow-sm">
        <h3 class="font-bold mb-2">Totals</h3>
        <div class="grid grid-cols-1 gap-2">
          <div class="p-3 rounded-lg bg-slate-50">
            <div class="text-xs text-slate-400">Revenue</div>
            <div id="totalInc" class="text-lg font-bold text-emerald-600">Ksh0.00</div>
          </div>
          <div class="p-3 rounded-lg bg-slate-50">
            <div class="text-xs text-slate-400">Expenses</div>
            <div id="totalExp" class="text-lg font-bold text-rose-500">Ksh0.00</div>
          </div>
          <div class="p-3 rounded-lg bg-gradient-to-br from-emerald-600 to-teal-500 text-white">
            <div class="text-xs text-white/80">Net</div>
            <div id="netTotal" class="text-lg font-bold">Ksh0.00</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sync & Controls -->
    <div class="bg-white rounded-2xl p-4 shadow-sm mb-4">
      <div class="flex flex-col md:flex-row gap-2 items-center">
        <div class="flex items-center gap-2">
          <label class="text-xs text-slate-500">Filter date</label>
          <input id="filterDate" type="date" class="px-3 py-2 rounded-lg border bg-slate-50 outline-none" />
          <button id="clearFilter" class="text-xs px-3 py-2 rounded-lg border">Clear</button>
        </div>

        <div class="ml-auto flex items-center gap-2">
          <button id="exportBtn" class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm">Export JSON</button>
          <button id="exportCsvBtn" class="px-3 py-2 rounded-lg bg-slate-700 text-white text-sm">Export CSV</button>
          <button id="importBtn" class="px-3 py-2 rounded-lg bg-slate-200 text-slate-800 text-sm">Import JSON</button>
          <input id="fileInput" type="file" accept=".json" class="hidden" />
          <button id="resetBtn" class="px-3 py-2 rounded-lg bg-red-500 text-white text-sm">Reset All</button>
        </div>
      </div>

      <hr class="my-3" />
      <div class="flex flex-col md:flex-row items-center gap-3">
        <div>
          <label class="text-xs text-slate-500">Cloud Sync (Supabase)</label>
          <div class="text-xs text-slate-400">Optional. Off by default — enable to back up & sync across devices.</div>
        </div>

        <div class="ml-auto flex items-center gap-2">
          <button id="enableSyncBtn" class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm">Enable Cloud Sync</button>
        </div>
      </div>
    </div>

    <!-- rest of the UI (Ledger, Debts, Inventory, Calendar/P&L) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <!-- Ledger -->
      <section class="bg-white p-4 rounded-2xl shadow-sm tab-anim">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold">General Ledger</h3>
          <div class="text-xs text-slate-400">Add income or expense</div>
        </div>

        <form id="ledgerForm" class="space-y-2">
          <div class="flex gap-2">
            <select id="ledgerType" class="px-3 py-2 rounded-lg border bg-slate-50 outline-none">
              <option value="income">Income (+)</option>
              <option value="expense">Expense (-)</option>
            </select>
            <input id="ledgerAmount" type="number" step="0.01" placeholder="Amount" class="flex-1 px-3 py-2 rounded-lg border bg-slate-50 outline-none" />
          </div>
          <div class="flex gap-2">
            <input id="ledgerDesc" type="text" placeholder="Description" class="flex-1 px-3 py-2 rounded-lg border bg-slate-50 outline-none" />
            <input id="ledgerDate" type="date" class="px-3 py-2 rounded-lg border bg-slate-50 outline-none" />
            <button type="submit" class="px-3 py-2 rounded-lg bg-emerald-600 text-white font-bold">Add</button>
          </div>
        </form>

        <div class="mt-4 max-h-56 overflow-y-auto no-scrollbar space-y-2">
          <div id="transactionsList" class="space-y-2"></div>
        </div>
      </section>

      <!-- Debt Manager -->
      <section class="bg-white p-4 rounded-2xl shadow-sm tab-anim">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold">Debt Manager</h3>
          <div class="text-xs text-slate-400">Track owed & owing</div>
        </div>

        <form id="debtForm" class="space-y-2">
          <div class="flex gap-2">
            <input id="debtPerson" type="text" placeholder="Person / Business" class="flex-1 px-3 py-2 rounded-lg border bg-slate-50 outline-none" />
            <select id="debtType" class="px-3 py-2 rounded-lg border bg-slate-50 outline-none">
              <option value="in">Collect (They owe you)</option>
              <option value="out">You owe</option>
            </select>
          </div>
          <div class="flex gap-2">
            <input id="debtAmount" type="number" step="0.01" placeholder="Amount" class="flex-1 px-3 py-2 rounded-lg border bg-slate-50 outline-none" />
            <button class="px-3 py-2 rounded-lg bg-emerald-600 text-white font-bold">Add Debt</button>
          </div>
        </form>

        <div class="mt-4 max-h-56 overflow-y-auto no-scrollbar space-y-2">
          <div id="debtsList" class="space-y-2"></div>
        </div>
      </section>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Inventory -->
      <section class="bg-white p-4 rounded-2xl shadow-sm tab-anim">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold">Inventory</h3>
          <div class="text-xs text-slate-400">Track stock</div>
        </div>

        <form id="inventoryForm" class="space-y-2">
          <div class="flex gap-2">
            <input id="itemName" type="text" placeholder="Item name" class="flex-1 px-3 py-2 rounded-lg border bg-slate-50 outline-none" />
            <input id="itemQty" type="number" min="0" placeholder="Qty" class="w-28 px-3 py-2 rounded-lg border bg-slate-50 outline-none" />
          </div>
          <div class="flex gap-2">
            <input id="itemPrice" type="number" step="0.01" placeholder="Unit price (optional)" class="flex-1 px-3 py-2 rounded-lg border bg-slate-50 outline-none" />
            <button class="px-3 py-2 rounded-lg bg-emerald-600 text-white font-bold">Add / Update</button>
          </div>
        </form>

        <div class="mt-4 max-h-56 overflow-y-auto no-scrollbar">
          <div id="inventoryList" class="space-y-2"></div>
        </div>
      </section>

      <!-- Calendar / P&L -->
      <section class="bg-white p-4 rounded-2xl shadow-sm tab-anim">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold">Profit & Loss & Calendar</h3>
          <div class="text-xs text-slate-400">Filter & summary</div>
        </div>

        <div class="mb-3">
          <label class="text-xs text-slate-500">Show transactions on</label>
          <input id="calendarDate" type="date" class="w-full px-3 py-2 rounded-lg border bg-slate-50 outline-none" />
        </div>

        <div class="space-y-3">
          <div class="p-3 rounded-lg bg-slate-50">
            <div class="text-xs text-slate-400">Revenue (all)</div>
            <div id="plRevenue" class="text-lg font-bold text-emerald-600">Ksh0.00</div>
          </div>
          <div class="p-3 rounded-lg bg-slate-50">
            <div class="text-xs text-slate-400">Expenses (all)</div>
            <div id="plExpense" class="text-lg font-bold text-rose-500">Ksh0.00</div>
          </div>
          <div class="p-3 rounded-lg bg-gradient-to-br from-emerald-600 to-teal-500 text-white">
            <div class="text-xs text-white/80">Net (all)</div>
            <div id="plNet" class="text-lg font-bold">Ksh0.00</div>
          </div>
        </div>

        <div class="mt-4">
          <div id="calendarList" class="max-h-48 overflow-y-auto no-scrollbar space-y-2"></div>
        </div>
      </section>
    </div>

    <footer class="mt-6 text-center text-xs text-slate-400">
      Offline-first (Dexie) + optional Supabase cloud sync. Export JSON/CSV to backup. Brand color: Deep Teal (#0F766E).
    </footer>
  </main>

  <script>
  /*******************************************************
   * client-side Dexie DB (same pattern as earlier)
   *******************************************************/
  const db = new Dexie("BookPesa_offline");
  db.version(1).stores({
    transactions: "++id,date,type,amount,description,createdAt",
    debts: "++id,person,type,status,amount,createdAt",
    inventory: "++id,name,qty,price",
    meta: "key"
  });

  (async () => {
    if(!(await db.meta.get('createdAt'))) await db.meta.put({ key:'createdAt', value: new Date().toISOString() });
  })();

  const $ = s => document.querySelector(s);
  const formatKES = v => { try { return new Intl.NumberFormat('en-KE',{ style:'currency', currency:'KES', maximumFractionDigits:2 }).format(Number(v||0)); } catch(e){ return 'Ksh'+Number(v||0).toFixed(2); } };
  const todayISO = () => new Date().toISOString().slice(0,10);
  const uid = () => Math.random().toString(36).slice(2,9);

  // Render logic (totals, transactions, debts, inventory, calendar)
  async function renderTotals(){
    const inc = (await db.transactions.where('type').equals('income').toArray()).reduce((s,t)=>s+Number(t.amount||0),0);
    const exp = (await db.transactions.where('type').equals('expense').toArray()).reduce((s,t)=>s+Number(t.amount||0),0);
    const net = inc - exp;
    $('#totalInc').textContent = formatKES(inc);
    $('#totalExp').textContent = formatKES(exp);
    $('#netTotal').textContent = formatKES(net);
    $('#plRevenue').textContent = formatKES(inc);
    $('#plExpense').textContent = formatKES(exp);
    $('#plNet').textContent = formatKES(net);
  }

  async function renderTransactions(filterDate=null){
    const container = $('#transactionsList'); container.innerHTML = '';
    const items = filterDate ? await db.transactions.where('date').equals(filterDate).reverse().toArray()
                             : await db.transactions.orderBy('createdAt').reverse().toArray();
    if(!items.length){ container.innerHTML = '<div class="text-xs text-slate-400">No transactions yet</div>'; return; }
    items.forEach(t=>{
      const el = document.createElement('div');
      el.className = 'flex items-center justify-between p-3 rounded-lg bg-slate-50 border';
      el.innerHTML = `
        <div>
          <div class="font-medium text-sm">${(t.description|| (t.type==='income'?'Income':'Expense'))}</div>
          <div class="text-xs text-slate-400">${t.date || (t.createdAt||'').slice(0,10)}</div>
        </div>
        <div class="flex items-center gap-2">
          <div class="font-bold ${t.type==='income'?'text-emerald-600':'text-rose-500'}">${t.type==='income'?'+':'-'}${formatKES(Number(t.amount).toFixed(2)).replace(/^Ksh|^KES|^KES\s?/,'')}</div>
          <button data-id="${t.id}" class="delTx text-xs text-slate-400 hover:text-rose-500">Delete</button>
        </div>`;
      container.appendChild(el);
    });

    container.querySelectorAll('.delTx').forEach(b => b.addEventListener('click', async e=>{
      await db.transactions.delete(Number(e.target.dataset.id)); await refreshAll();
    }));
  }

  async function renderDebts(){
    const list = $('#debtsList'); list.innerHTML = '';
    const items = await db.debts.orderBy('createdAt').reverse().toArray();
    if(!items.length){ list.innerHTML = '<div class="text-xs text-slate-400">No debts recorded</div>'; return; }
    items.forEach(d=>{
      const el = document.createElement('div');
      el.className = 'p-3 rounded-lg bg-slate-50 border flex items-center justify-between';
      el.innerHTML = `
        <div>
          <div class="font-medium text-sm">${d.person}</div>
          <div class="text-xs text-slate-400">${d.type==='in'?'They owe you':'You owe'}</div>
        </div>
        <div class="flex items-center gap-2">
          <div class="font-bold ${d.type==='in'?'text-emerald-600':'text-rose-500'}">${formatKES(d.amount)}</div>
          <button data-id="${d.id}" class="toggleDebt text-xs ${d.status==='paid'?'text-green-600':'text-slate-400'}">${d.status==='paid'?'Paid':'Mark Paid'}</button>
          <button data-id="${d.id}" class="delDebt text-xs text-slate-400 hover:text-rose-500">Delete</button>
        </div>`;
      list.appendChild(el);
    });

    list.querySelectorAll('.toggleDebt').forEach(b => b.addEventListener('click', async e=>{
      const id = Number(e.target.dataset.id);
      const rec = await db.debts.get(id);
      await db.debts.update(id, { status: rec.status === 'paid' ? 'pending' : 'paid' }); await refreshAll();
    }));
    list.querySelectorAll('.delDebt').forEach(b => b.addEventListener('click', async e=>{
      await db.debts.delete(Number(e.target.dataset.id)); await refreshAll();
    }));
  }

  async function renderInventory(){
    const container = $('#inventoryList'); container.innerHTML = '';
    const items = await db.inventory.orderBy('name').toArray();
    if(!items.length){ container.innerHTML = '<div class="text-xs text-slate-400">No stock yet</div>'; return; }
    items.forEach(it=>{
      const el = document.createElement('div');
      el.className = 'p-3 rounded-lg bg-slate-50 border flex items-center justify-between';
      el.innerHTML = `
        <div>
          <div class="font-medium">${it.name}</div>
          <div class="text-xs text-slate-400">Qty: ${it.qty} ${it.price? '• '+formatKES(it.price):''}</div>
        </div>
        <div class="flex items-center gap-2">
          <input data-id="${it.id}" data-role="qty" type="number" class="w-20 px-2 py-1 rounded border bg-white text-sm" value="${it.qty}" />
          <button data-id="${it.id}" class="delItem text-xs text-slate-400 hover:text-rose-500">Delete</button>
        </div>`;
      container.appendChild(el);
    });

    container.querySelectorAll('input[data-role="qty"]').forEach(inp => inp.addEventListener('change', async e=>{
      await db.inventory.update(Number(e.target.dataset.id), { qty: Number(e.target.value) || 0 }); await refreshAll();
    }));
    container.querySelectorAll('.delItem').forEach(b => b.addEventListener('click', async e=>{
      await db.inventory.delete(Number(e.target.dataset.id)); await refreshAll();
    }));
  }

  async function renderCalendarList(dateStr){
    const container = $('#calendarList'); container.innerHTML = '';
    if(!dateStr){ container.innerHTML = '<div class="text-xs text-slate-400">Select a date to view transactions</div>'; return; }
    const items = await db.transactions.where('date').equals(dateStr).toArray();
    if(!items.length){ container.innerHTML = '<div class="text-xs text-slate-400">No transactions on this date</div>'; return; }
    items.forEach(t=>{
      const el = document.createElement('div');
      el.className = 'p-2 rounded border bg-slate-50 flex items-center justify-between';
      el.innerHTML = `<div class="text-sm">${t.description || (t.type==='income'?'Income':'Expense')}</div>
                      <div class="${t.type==='income'?'text-emerald-600 font-bold':'text-rose-500 font-bold'}">${t.type==='income'?'+':'-'}${formatKES(t.amount).replace(/^Ksh|^KES/,'')}</div>`;
      container.appendChild(el);
    });
  }

  /* Actions */
  $('#cashInBtn').addEventListener('click', async ()=>{
    const amt = Number($('#quickAmount').value || 0); if(!amt) return alert('Enter amount');
    const note = $('#quickNote').value || 'Cash Sale';
    await db.transactions.add({ date: todayISO(), type:'income', amount: amt, description: note, createdAt: new Date().toISOString() });
    $('#quickAmount').value=''; $('#quickNote').value=''; await refreshAll();
  });
  $('#cashOutBtn').addEventListener('click', async ()=>{
    const amt = Number($('#quickAmount').value || 0); if(!amt) return alert('Enter amount');
    const note = $('#quickNote').value || 'Petty Cash';
    await db.transactions.add({ date: todayISO(), type:'expense', amount: amt, description: note, createdAt: new Date().toISOString() });
    $('#quickAmount').value=''; $('#quickNote').value=''; await refreshAll();
  });

  $('#ledgerForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const type = $('#ledgerType').value;
    const amt = Number($('#ledgerAmount').value || 0); if(!amt) return alert('Enter amount');
    const desc = $('#ledgerDesc').value || (type==='income'?'Income':'Expense');
    const date = $('#ledgerDate').value || todayISO();
    await db.transactions.add({ date, type, amount: amt, description: desc, createdAt: new Date().toISOString() });
    $('#ledgerAmount').value=''; $('#ledgerDesc').value=''; $('#ledgerDate').value=''; await refreshAll();
  });

  $('#debtForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const person = $('#debtPerson').value || 'Unnamed';
    const amount = Number($('#debtAmount').value || 0); if(!amount) return alert('Enter amount');
    const type = $('#debtType').value;
    await db.debts.add({ person, amount, type, status: 'pending', createdAt: new Date().toISOString() });
    $('#debtPerson').value=''; $('#debtAmount').value=''; await refreshAll();
  });

  $('#inventoryForm').addEventList