<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Book 7 Lite ‚Äî Ledger + Debt Manager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --accent:#0a7cff; --card:#fff; --bg:#f4f6f8; --muted:#666;
      --danger:#e74c3c; --success:#27ae60; --warning:#f39c12;
    }
    body{
      margin:0; padding:16px; font-family:Inter, system-ui, Arial;
      background:var(--bg); color:#111;
    }
    header{text-align:center; margin-bottom:12px;}
    h1{margin:0; font-size:20px}
    .card{
      background:var(--card); border-radius:10px; padding:14px;
      box-shadow:0 2px 6px rgba(0,0,0,0.06); margin-bottom:12px;
    }
    .balance{font-size:20px; font-weight:700; color:var(--accent); text-align:center;}
    label{display:block; font-weight:600; margin-top:8px; color:#222;}
    input, select, button, textarea{
      width:100%; padding:10px; margin-top:6px; box-sizing:border-box;
      border-radius:8px; border:1px solid #ddd; font-size:15px;
    }
    .row{display:flex; gap:10px;}
    .col{flex:1;}
    .small{font-size:13px; color:var(--muted);}
    button.primary{background:var(--accent); color:#fff; border:none; font-weight:700;}
    button.warning{background:var(--warning); color:#fff; border:none; font-weight:700;}
    .ledger-list, .debt-list{list-style:none; margin:0; padding:0;}
    li.item{padding:12px 8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:flex-start;}
    .left{flex:1}
    .meta{color:var(--muted); font-size:13px; margin-top:6px}
    .btn{border-radius:6px; padding:6px 10px; border:1px solid #ddd; background:#fff; cursor:pointer;}
    .btn.danger{border-color:var(--danger); color:var(--danger); background:rgba(231,76,60,0.04)}
    .btn.warning{border-color:var(--warning); color:var(--warning); background:rgba(243,156,18,0.08);}
    .btn.success{border-color:var(--success); color:var(--success); background:rgba(39,174,96,0.04)}
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; margin-left:6px;}
    .badge.pending{background:#f0f5ff; color:var(--accent);}
    .badge.paid{background:rgba(39,174,96,0.12); color:var(--success);}
    .badge.partial{background:#fff7e6; color:#b17000;}
    .badge.overdue{background:rgba(231,76,60,0.1); color:var(--danger);}
    .totals{display:flex; gap:10px; justify-content:space-between; margin-top:8px;}
    .totals .box{flex:1; text-align:center; padding:10px; border-radius:8px; background:#fbfdff; border:1px solid #eef6ff;}
    .controls{display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap;}
    .muted-line{color:var(--muted); font-size:13px; margin-top:6px;}
    .debt-actions{display:flex; gap:6px; margin-left:8px;}
    .history{font-size:13px; color:var(--muted); margin-top:6px;}
    .small-btn{font-size:13px; padding:6px 8px;}
    .history-item-actions{margin-left:auto;}
    @media(min-width:720px){
      .row{flex-wrap:nowrap;}
      .col-half{flex:0 0 48%;}
    }
  </style>
</head>
<body>

<header>
  <h1>üìò Book 7 Lite MVP</h1>
  <div class="small muted-line">Ledger + Advanced Debt Manager</div>
</header>

<div class="card">
  <div class="balance">Balance: Ksh <span id="balance">0.00</span></div>
</div>

<div class="card" id="add-transaction-card">
  <h3 style="margin:0 0 8px 0" id="ledger-title">‚ûï Add Transaction (Ledger)</h3>
  <input type="hidden" id="ledger-edit-id" />
  <div class="row">
    <div class="col">
      <label for="desc">Description</label>
      <input id="desc" placeholder="e.g., Sale, Rent" />
    </div>
    <div style="width:130px" class="col">
      <label for="amount">Amount</label>
      <input id="amount" type="number" placeholder="e.g., 5000" />
    </div>
  </div>
  <div class="row" style="margin-top:8px;">
    <div class="col">
      <label for="type">Type</label>
      <select id="type">
        <option value="income">Income</option>
        <option value="expense">Expense</option>
      </select>
    </div>
    <div style="width:160px">
      <label>&nbsp;</label>
      <button class="primary" id="ledger-submit-btn" onclick="addTransaction()">Save to Ledger</button>
    </div>
  </div>
</div>

<div class="card">
  <h3 style="margin:0 0 8px 0" id="debt-title">üè¶ Debt Manager (Advanced)</h3>
  <input type="hidden" id="debt-edit-id" />

  <div class="controls">
    <div style="flex:1; min-width:160px;">
      <label for="debt-type">Debt Type</label>
      <select id="debt-type">
        <option value="owed">Owed to me</option>
        <option value="owe">I owe</option>
      </select>
    </div>
    <div style="width:120px;">
      <label for="debt-amount">Amount</label>
      <input id="debt-amount" type="number" placeholder="0" />
    </div>
    <div style="flex:1; min-width:160px;">
      <label for="debt-name">Name</label>
      <input id="debt-name" placeholder="Person or business" />
    </div>
  </div>

  <div class="row">
    <div class="col">
      <label for="debt-reason">Reason / Note</label>
      <input id="debt-reason" placeholder="e.g., goods sold, loan" />
    </div>
    <div style="width:160px">
      <label for="debt-due">Due Date</label>
      <input id="debt-due" type="date" />
    </div>
    <div style="width:160px">
      <label>&nbsp;</label>
      <button class="primary" id="debt-submit-btn" onclick="addDebt()">Add Debt</button>
    </div>
  </div>

  <div class="totals" style="margin-top:12px;">
    <div class="box">
      <div class="small muted-line">Total Owed to Me</div>
      <div style="font-weight:800; font-size:18px; margin-top:6px;">Ksh <span id="total-owed">0.00</span></div>
    </div>
    <div class="box">
      <div class="small muted-line">Total I Owe</div>
      <div style="font-weight:800; font-size:18px; margin-top:6px;">Ksh <span id="total-owe">0.00</span></div>
    </div>
    <div class="box">
      <div class="small muted-line">Net Position</div>
      <div style="font-weight:800; font-size:18px; margin-top:6px;">Ksh <span id="net-pos">0.00</span></div>
    </div>
  </div>

  <div style="margin-top:12px;" class="controls">
    <div style="flex:1;">
      <label for="filter-type">Filter Type</label>
      <select id="filter-type" onchange="renderDebts()">
        <option value="all">All</option>
        <option value="owed">Owed to me</option>
        <option value="owe">I owe</option>
      </select>
    </div>
    <div style="width:160px;">
      <label for="filter-status">Filter Status</label>
      <select id="filter-status" onchange="renderDebts()">
        <option value="all">All</option>
        <option value="pending">Pending</option>
        <option value="partial">Partially Paid</option>
        <option value="paid">Paid</option>
        <option value="overdue">Overdue</option>
      </select>
    </div>
    <div style="width:160px;">
      <label for="sort-by">Sort By</label>
      <select id="sort-by" onchange="renderDebts()">
        <option value="newest">Newest</option>
        <option value="oldest">Oldest</option>
        <option value="due-asc">Due Date ‚Üë</option>
        <option value="due-desc">Due Date ‚Üì</option>
        <option value="amount-desc">Remaining ‚Üì</option>
        <option value="amount-asc">Remaining ‚Üë</option>
      </select>
    </div>
  </div>

</div>

<div class="card">
  <h3 style="margin:0 0 8px 0">üìã Debts</h3>
  <ul id="debt-list" class="debt-list"></ul>
</div>

<div class="card">
  <h3 style="margin:0 0 8px 0">üìò Ledger</h3>
  <ul id="list" class="ledger-list"></ul>
</div>

<div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;">
  <div style="background:#fff; border-radius:10px; max-width:720px; width:94%; padding:16px; max-height:80vh; overflow:auto;" id="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 id="modal-title">History</h3>
      <button class="btn" onclick="closeModal()">Close</button>
    </div>
    <div id="modal-body"></div>
  </div>
</div>

<script>
/* -------------------------
  Storage & Structures
---------------------------*/
let transactions = JSON.parse(localStorage.getItem('book7data')) || [];
let debts = JSON.parse(localStorage.getItem('book7-debts')) || [];

/* Utility: safe number parsing (digit-by-digit style care) */
function toNumber(v){
  const n = Number(v);
  if (Number.isFinite(n)) return Math.round(n*100)/100; // 2 decimals
  return 0;
}
/* Generate simple unique ID */
function generateId(prefix) {
    return prefix + Date.now() + Math.floor(Math.random() * 999);
}

/* Save */
function saveAll(){
  localStorage.setItem('book7data', JSON.stringify(transactions));
  localStorage.setItem('book7-debts', JSON.stringify(debts));
}

/* -------------------------
  Ledger functions (Add, Edit, Delete)
---------------------------*/
function resetLedgerForm(){
    document.getElementById('ledger-edit-id').value = '';
    document.getElementById('desc').value = '';
    document.getElementById('amount').value = '';
    document.getElementById('type').value = 'income';
    document.getElementById('ledger-submit-btn').innerText = 'Save to Ledger';
    document.getElementById('ledger-submit-btn').onclick = addTransaction;
    document.getElementById('ledger-submit-btn').className = 'primary';
    document.getElementById('ledger-title').innerText = '‚ûï Add Transaction (Ledger)';
}

function editTransaction(id){
    const t = transactions.find(x => x.id === id);
    if (!t) return alert('Transaction not found');

    // Populate form
    document.getElementById('ledger-edit-id').value = t.id;
    document.getElementById('desc').value = t.desc;
    document.getElementById('amount').value = t.amount;
    document.getElementById('type').value = t.type;
    
    // Change button to Update
    document.getElementById('ledger-submit-btn').innerText = 'Update Transaction';
    document.getElementById('ledger-submit-btn').onclick = updateTransaction;
    document.getElementById('ledger-submit-btn').className = 'warning';
    document.getElementById('ledger-title').innerText = '‚úèÔ∏è Edit Transaction (Ledger)';
    
    // Scroll to form
    document.getElementById('add-transaction-card').scrollIntoView({ behavior: 'smooth' });
}

function updateTransaction(){
    const id = document.getElementById('ledger-edit-id').value;
    const index = transactions.findIndex(x => x.id === id);
    if (index === -1) { alert('Transaction not found for update'); resetLedgerForm(); return; }
    
    const desc = document.getElementById('desc').value.trim();
    const amount = toNumber(document.getElementById('amount').value);
    const type = document.getElementById('type').value;

    if (!desc || !amount){ alert('Fill description and a valid amount'); return; }

    // Update object properties
    transactions[index].desc = desc;
    transactions[index].amount = amount;
    transactions[index].type = type;
    
    // Cleanup and refresh
    saveAll(); 
    renderList(); 
    calculateBalance();
    resetLedgerForm();
}

function calculateBalance(){
  let balance = 0;
  transactions.forEach(t => {
    if (t.type === 'income') balance += toNumber(t.amount);
    else balance -= toNumber(t.amount);
  });
  document.getElementById('balance').innerText = balance.toFixed(2);
}

function renderList(){
  const list = document.getElementById('list');
  list.innerHTML = '';
  const sorted = [...transactions].sort((a,b)=> new Date(b.date) - new Date(a.date));
  
  if (sorted.length === 0) {
      list.innerHTML = '<li class="item"><div class="left"><div class="meta">No ledger entries yet.</div></div></li>';
      return;
  }
  
  sorted.forEach(t=>{
    const li = document.createElement('li');
    li.className='item';
    const left = document.createElement('div'); left.className='left';
    const prettyType = (t.type||'').toUpperCase();
    const prettyDate = t.date ? new Date(t.date).toLocaleString() : '‚Äî';
    left.innerHTML = `<strong>${prettyType}</strong> - ${escapeHtml(t.desc || '')}
      <div class="meta">Amount: Ksh ${Number(t.amount).toFixed(2)}<br><small>${prettyDate}</small></div>`;
    
    const actions = document.createElement('div');
    const edit = document.createElement('button'); edit.className='btn warning small-btn'; edit.innerText='Edit';
    edit.onclick = ()=> editTransaction(t.id);
    const del = document.createElement('button'); del.className='btn danger small-btn'; del.innerText='Delete';
    del.onclick = ()=>{ if(confirm('Delete this ledger entry? This cannot be undone.')){ transactions = transactions.filter(x=>x.id !== t.id); saveAll(); renderList(); calculateBalance(); } };
    actions.appendChild(edit);
    actions.appendChild(del);
    li.appendChild(left); li.appendChild(actions);
    list.appendChild(li);
  });
}

/* Add transaction (ledger) */
function addTransaction(){
  const desc = document.getElementById('desc').value.trim();
  const amount = toNumber(document.getElementById('amount').value);
  const type = document.getElementById('type').value;
  if (!desc || !amount || amount <= 0){ alert('Enter description and a positive amount'); return; }
  const obj = { id: generateId('t-'), desc, amount, type, date:new Date().toISOString() };
  transactions.push(obj); saveAll(); renderList(); calculateBalance();
  resetLedgerForm(); // Use reset function to clear inputs
}


/* -------------------------
  Debt Manager functions (Add, Edit, Delete, Payment)
---------------------------*/

function resetDebtForm(){
    document.getElementById('debt-edit-id').value = '';
    document.getElementById('debt-type').value = 'owed';
    document.getElementById('debt-amount').value = '';
    document.getElementById('debt-name').value = '';
    document.getElementById('debt-reason').value = '';
    document.getElementById('debt-due').value = '';
    document.getElementById('debt-submit-btn').innerText = 'Add Debt';
    document.getElementById('debt-submit-btn').onclick = addDebt;
    document.getElementById('debt-submit-btn').className = 'primary';
    document.getElementById('debt-title').innerText = 'üè¶ Debt Manager (Advanced)';
    // Re-enable debt type and amount fields when adding
    document.getElementById('debt-type').disabled = false;
    document.getElementById('debt-amount').disabled = false;
}

function editDebt(id){
    const d = debts.find(x => x.id === id);
    if (!d) return alert('Debt not found');

    // Populate form
    document.getElementById('debt-edit-id').value = d.id;
    document.getElementById('debt-type').value = d.type;
    document.getElementById('debt-amount').value = d.amount;
    document.getElementById('debt-name').value = d.name;
    document.getElementById('debt-reason').value = d.reason;
    document.getElementById('debt-due').value = d.due || '';
    
    // Crucial: Prevent editing type/original amount once payments are recorded
    if (d.history.length > 0) {
        alert('Cannot edit original amount or type after a payment has been recorded. You can only edit Name, Reason, and Due Date.');
        document.getElementById('debt-type').disabled = true;
        document.getElementById('debt-amount').disabled = true;
    } else {
        document.getElementById('debt-type').disabled = false;
        document.getElementById('debt-amount').disabled = false;
    }

    // Change button to Update
    document.getElementById('debt-submit-btn').innerText = 'Update Debt';
    document.getElementById('debt-submit-btn').onclick = updateDebt;
    document.getElementById('debt-submit-btn').className = 'warning';
    document.getElementById('debt-title').innerText = '‚úèÔ∏è Edit Debt Entry';
}

function updateDebt(){
    const id = document.getElementById('debt-edit-id').value;
    const index = debts.findIndex(x => x.id === id);
    if (index === -1) { alert('Debt not found for update'); resetDebtForm(); return; }
    
    const d = debts[index];
    const type = document.getElementById('debt-type').value;
    const amount = toNumber(document.getElementById('debt-amount').value);
    const name = document.getElementById('debt-name').value.trim();
    const reason = document.getElementById('debt-reason').value.trim();
    const due = document.getElementById('debt-due').value || null;

    if (!name || !amount || amount <= 0){ alert('Enter name and a positive amount'); return; }

    // If original amount is changed, recalculate remaining ONLY if no history exists
    if (d.amount !== amount && d.history.length === 0) {
        d.remaining = amount;
    } else if (d.amount !== amount && d.history.length > 0) {
        // This case is already blocked in editDebt(), but serves as a final guard
        alert('Cannot change the original amount after payments have been recorded. Re-add the debt if you need to change the amount.');
        resetDebtForm();
        return;
    }
    
    // Update properties
    d.type = type;
    d.amount = amount; 
    d.name = name;
    d.reason = reason;
    d.due = due;
    
    // Cleanup and refresh
    d.status = computeDebtStatus(d); 
    saveAll(); 
    renderDebts();
    resetDebtForm();
}


function computeDebtStatus(d){
  const today = new Date();
  today.setHours(0,0,0,0); // Normalize today's date
  const remaining = toNumber(d.remaining);
  
  if (remaining <= 0) return 'paid';
  
  // Overdue check
  if (d.due){
    const dueDate = new Date(d.due);
    dueDate.setHours(0,0,0,0); // Normalize due date
    if (dueDate < today) return 'overdue';
  }
  
  // partial if some payments exist but remaining > 0
  if ((d.history && d.history.length > 0) && remaining > 0) return 'partial';
  return 'pending';
}

function addDebt(){
  const type = document.getElementById('debt-type').value; // owed | owe
  const amount = toNumber(document.getElementById('debt-amount').value);
  const name = document.getElementById('debt-name').value.trim();
  const reason = document.getElementById('debt-reason').value.trim();
  const due = document.getElementById('debt-due').value || null;
  if (!name || !amount || amount <= 0){ alert('Enter name and a positive amount'); return; }
  
  const obj = {
    id: generateId('d-'),
    type,
    name,
    amount,
    remaining: amount,
    reason,
    due,
    history: [],
    created: new Date().toISOString()
  };
  debts.push(obj); saveAll(); renderDebts(); calculateBalance();
  resetDebtForm();
}

/* Render debts */
function renderDebts(){
  const list = document.getElementById('debt-list');
  list.innerHTML='';
  // filters
  const fType = document.getElementById('filter-type').value;
  const fStatus = document.getElementById('filter-status').value;
  const sortBy = document.getElementById('sort-by').value;

  let shown = debts.map(d=>{
    d.status = computeDebtStatus(d);
    return d;
  });

  if (fType !== 'all') shown = shown.filter(s=>s.type === fType);
  if (fStatus !== 'all') shown = shown.filter(s=>s.status === fStatus);

  // sort
  shown.sort((a,b)=>{
    if (sortBy==='newest') return new Date(b.created) - new Date(a.created);
    if (sortBy==='oldest') return new Date(a.created) - new Date(b.created);
    if (sortBy==='due-asc') return (a.due?new Date(a.due):0) - (b.due?new Date(b.due):0);
    if (sortBy==='due-desc') return (b.due?new Date(b.due):0) - (a.due?new Date(b.due):0);
    if (sortBy==='amount-desc') return b.remaining - a.remaining;
    if (sortBy==='amount-asc') return a.remaining - b.remaining;
    return 0;
  });

  // totals
  let totalOwed=0, totalOwe=0;
  debts.forEach(d=>{
    if (d.type ==='owed') totalOwed += toNumber(d.remaining);
    else totalOwe += toNumber(d.remaining);
  });
  document.getElementById('total-owed').innerText = totalOwed.toFixed(2);
  document.getElementById('total-owe').innerText = totalOwe.toFixed(2);
  document.getElementById('net-pos').innerText = (totalOwed - totalOwe).toFixed(2);
  
  if (shown.length === 0) {
      list.innerHTML = '<li class="item"><div class="left"><div class="meta">No debt entries ma