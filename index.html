<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Book7 â€” MVP</title>
<style>
  :root{
    --bg:#071028; --card:#071629; --accent:#06b6d4; --muted:#9aa6b2; --accent2:#f59e0b;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#e6eef6;background:linear-gradient(180deg,#061322 0%, #041226 100%);}
  .wrap{max-width:1100px;margin:12px auto;padding:12px;display:grid;grid-template-columns:1fr 380px;gap:14px;}
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:6px;}
  h1{font-size:20px;margin:0;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);}
  .left{display:flex;flex-direction:column; gap:12px;}
  .right{display:flex;flex-direction:column; gap:12px;}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;}
  input,select,textarea,button{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#e6eef6;padding:8px;border-radius:8px;min-height:40px;}
  input:focus,select:focus,textarea:focus{outline:2px solid rgba(6,182,212,0.12);}
  .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#031123;border:none;padding:9px 12px;border-radius:8px;cursor:pointer;}
  .muted{color:var(--muted);font-size:13px;}
  table{width:100%;border-collapse:collapse;font-size:13px;}
  th,td{padding:6px 8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);color:var(--muted);}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
  .day{min-height:64px;padding:8px;border-radius:8px;background:var(--glass);font-size:13px;position:relative;}
  .badge{display:inline-block;padding:3px 6px;border-radius:999px;background:rgba(6,182,212,0.12);color:var(--accent);font-size:12px;margin-top:6px;}
  .flex{display:flex;gap:8px;align-items:center;}
  footer{grid-column:1/-1;text-align:center;color:var(--muted);font-size:12px;padding-top:6px;}
  @media(max-width:960px){ .wrap{grid-template-columns:1fr;} .right{order:2} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Book7 â€” MVP</h1>
      <div class="muted">Ledger â€¢ P&L â€¢ Calendar â€¢ Debts â€¢ Inventory â€” Local storage</div>
    </div>
    <div class="flex">
      <button id="exportBtn" class="btn">Export JSON</button>
      <input id="fileInput" type="file" accept="application/json" style="display:none" />
      <button id="importBtn" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">Import</button>
    </div>
  </header>

  <main class="left">
    <!-- Quick Entry -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>Quick Entry</strong>
        <div class="muted">Balance: <span id="balance">0.00</span></div>
      </div>

      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
        <div style="flex:1;">
          <label>Date</label>
          <input id="entryDate" type="date" />
        </div>
        <div style="flex:1;">
          <label>Account / Party</label>
          <input id="entryAccount" placeholder="Cash, Mpesa, Client A" />
        </div>
      </div>

      <div style="margin-top:8px;display:flex;gap:8px;align-items:end;">
        <div style="width:140px;">
          <label>Type</label>
          <select id="entryType">
            <option value="income">Income (credit)</option>
            <option value="expense">Expense (debit)</option>
            <option value="transfer">Transfer</option>
          </select>
        </div>
        <div style="width:140px;">
          <label>Amount</label>
          <input id="entryAmount" type="number" min="0" step="0.01" />
        </div>
        <div style="flex:1;">
          <label>Category</label>
          <input id="entryCategory" placeholder="Sales, Salary, Supplies" />
        </div>
        <div style="width:170px;display:flex;flex-direction:column;gap:6px;">
          <button id="voiceBtn" class="btn">ðŸŽ¤ Voice</button>
          <button id="addEntry" class="btn">Add Entry</button>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label>Note</label>
        <input id="entryNote" placeholder="Short note or invoice #" />
      </div>

      <div style="margin-top:8px;" id="aiTip" class="muted">AI tips appear here</div>
    </section>

    <!-- Ledger -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>Ledger</strong>
        <div class="muted">Entries: <span id="entriesCount">0</span></div>
      </div>
      <div style="margin-top:8px;max-height:260px;overflow:auto">
        <table id="ledgerTable">
          <thead><tr><th>Date</th><th>Account</th><th>Type</th><th>Category</th><th>Amount</th><th>Note</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- P&L -->
    <section class="card">
      <strong>Profit & Loss</strong>
      <div style="display:flex;justify-content:space-between;margin-top:8px;">
        <div>
          <div class="muted">Total Income</div>
          <div id="totalIncome">0.00</div>
        </div>
        <div>
          <div class="muted">Total Expense</div>
          <div id="totalExpense">0.00</div>
        </div>
        <div>
          <div class="muted">Net</div>
          <div id="netProfit">0.00</div>
        </div>
      </div>
    </section>
  </main>

  <aside class="right">
    <!-- Calendar -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>Calendar</strong>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="prevMonth" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">â—€</button>
          <div id="monthLabel" class="muted">Month</div>
          <button id="nextMonth" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">â–¶</button>
        </div>
      </div>
      <div style="margin-top:8px;" id="calendarGrid" class="calendar"></div>
    </section>

    <!-- Debts -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>Debts</strong>
        <button id="addDebt" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">Add</button>
      </div>
      <div style="margin-top:8px;max-height:150px;overflow:auto">
        <table id="debtsTable"><thead><tr><th>Party</th><th>Amt</th><th>Type</th><th></th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <!-- Inventory -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>Inventory</strong>
        <button id="addItemBtn" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">Add</button>
      </div>
      <div style="margin-top:8px;max-height:150px;overflow:auto">
        <table id="inventoryTable"><thead><tr><th>Item</th><th>Qty</th><th>Cost</th><th>Value</th><th></th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="card">
      <strong>Tools</strong>
      <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px;">
        <button id="clearAll" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">Clear Data</button>
        <button id="helpBtn" class="btn">How to use</button>
      </div>
    </section>
  </aside>

  <footer class="card muted">
    Book7 MVP â€” data saved locally in your browser. Use Export to backup. Works offline after first load.
  </footer>
</div>

<script>
/* Book7 â€” Single-file MVP JS */
const $ = id => document.getElementById(id);
const qs = sel => document.querySelector(sel);

// storage key
const STORAGE_KEY = 'book7_data_v1';

// state
let state = {
  entries: [], // {date, account, type, category, amount, note, id}
  debts: [],   // {party, amount, type, id}
  inventory: [], // {name, qty, cost, id}
  settings: { monthOffset: 0 }
};

// helpers
const formatMoney = n => Number(n || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,7);
const todayISO = () => new Date().toISOString().slice(0,10);
const safeNum = v => Number(v || 0);

// load/save
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) state = JSON.parse(raw);
  } catch(e){ console.error('load error', e); }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  renderAll();
}

// render functions
function renderLedger(){
  const tbody = qs('#ledgerTable tbody');
  tbody.innerHTML = '';
  // sort descending by date then created id
  const entries = [...state.entries].sort((a,b)=> new Date(b.date) - new Date(a.date) || b.id.localeCompare(a.id));
  entries.forEach(e=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${e.date}</td><td>${escapeHtml(e.account)}</td><td>${e.type}</td><td>${escapeHtml(e.category)}</td><td style="text-align:right">${formatMoney(e.amount)}</td><td>${escapeHtml(e.note)}</td><td><button data-id="${e.id}" class="delEntry" style="background:none;border:none;color:var(--muted);cursor:pointer">âœ–</button></td>`;
    tbody.appendChild(tr);
  });
  $('entriesCount').textContent = entries.length;
  computePL();
  computeBalance();
  renderCalendar();
}

function renderDebts(){
  const tbody = qs('#debtsTable tbody'); tbody.innerHTML = '';
  state.debts.forEach(d=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(d.party)}</td><td style="text-align:right">${formatMoney(d.amount)}</td><td>${d.type}</td><td><button data-id="${d.id}" class="delDebt" style="background:none;border:none;color:var(--muted);cursor:pointer">âœ–</button></td>`;
    tbody.appendChild(tr);
  });
}

function renderInventory(){
  const tbody = qs('#inventoryTable tbody'); tbody.innerHTML = '';
  state.inventory.forEach(it=>{
    const value = safeNum(it.qty) * safeNum(it.cost);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(it.name)}</td><td style="text-align:right">${it.qty}</td><td style="text-align:right">${formatMoney(it.cost)}</td><td style="text-align:right">${formatMoney(value)}</td><td><button data-id="${it.id}" class="delItem" style="background:none;border:none;color:var(--muted);cursor:pointer">âœ–</button></td>`;
    tbody.appendChild(tr);
  });
}

function computePL(){
  const income = state.entries.filter(e=>e.type==='income').reduce((s,e)=>s+safeNum(e.amount),0);
  const expense = state.entries.filter(e=>e.type==='expense').reduce((s,e)=>s+safeNum(e.amount),0);
  $('totalIncome').textContent = formatMoney(income);
  $('totalExpense').textContent = formatMoney(expense);
  $('netProfit').textContent = formatMoney(income - expense);
}

function computeBalance(){
  const bal = state.entries.reduce((s,e)=> e.type==='income' ? s + safeNum(e.amount) : e.type==='expense' ? s - safeNum(e.amount) : s, 0);
  $('balance').textContent = formatMoney(bal);
}

// calendar
function renderCalendar(){
  const grid = $('calendarGrid'); grid.innerHTML = '';
  const d = new Date();
  const offset = state.settings.monthOffset || 0;
  d.setMonth(d.getMonth() + offset);
  const year = d.getFullYear(), month = d.getMonth();
  $('monthLabel').textContent = d.toLocaleString(undefined, {month:'long', year:'numeric'});

  // headers (Mon..Sun)
  const weekdays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  weekdays.forEach(w=>{
    const cell = document.createElement('div'); cell.className = 'day'; cell.style.fontWeight = '700'; cell.style.background = 'transparent'; cell.style.border = 'none'; cell.textContent = w; grid.appendChild(cell);
  });

  const first = new Date(year, month, 1);
  const startDay = (first.getDay() + 6) % 7; // monday-first
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  for(let i=0;i<startDay;i++){ const empty = document.createElement('div'); empty.className='day'; grid.appendChild(empty); }
  for(let day=1; day<=daysInMonth; day++){
    const cell = document.createElement('div'); cell.className = 'day';
    const dateStr = new Date(year, month, day).toISOString().slice(0,10);
    const header = document.createElement('div'); header.style.fontWeight='700'; header.textContent = day; cell.appendChild(header);
    const todays = state.entries.filter(en => en.date === dateStr);
    todays.slice(0,3).forEach(t => {
      const b = document.createElement('div'); b.className='badge'; b.textContent = `${t.type==='income' ? '+' : '-'} ${t.category||t.account} ${formatMoney(t.amount)}`; cell.appendChild(b);
    });
    if(todays.length > 3){
      const more = document.createElement('div'); more.className='muted'; more.textContent = `+${todays.length-3} more`; more.style.marginTop='6px'; cell.appendChild(more);
    }
    // attach data-date for clicking
    cell.dataset.date = dateStr;
    grid.appendChild(cell);
  }
}

// UI actions
$('addEntry').onclick = () => {
  const date = $('entryDate').value || todayISO();
  const account = $('entryAccount').value.trim() || 'Unknown';
  const type = $('entryType').value;
  const amount = safeNum($('entryAmount').value);
  const category = $('entryCategory').value.trim() || (type==='income' ? 'Sales' : 'General');
  const note = $('entryNote').value.trim();
  if(!amount || amount <= 0){ alert('Enter a valid amount'); return; }
  const item = { id: uid(), date, account, type, amount, category, note };
  state.entries.push(item);
  saveState();
  clearEntryForm();
  showAiTip();
};

function clearEntryForm(){
  $('entryAmount').value = '';
  $('entryNote').value = '';
  $('entryCategory').value = '';
  $('entryAccount').value = '';
  $('entryDate').value = todayISO();
}

// delete handlers via delegation
document.addEventListener('click', (e) => {
  if(e.target.classList.contains('delEntry')){
    const id = e.target.dataset.id;
    if(confirm('Delete entry?')){ state.entries = state.entries.filter(x => x.id !== id); saveState(); }
  } else if(e.target.classList.contains('delDebt')){
    const id = e.target.dataset.id;
    if(confirm('Remove debt?')){ state.debts = state.debts.filter(x => x.id !== id); saveState(); }
  } else if(e.target.classList.contains('delItem')){
    const id = e.target.dataset.id;
    if(confirm('Remove item?')){ state.inventory = state.inventory.filter(x => x.id !== id); saveState(); }
  }
});

// debts & inventory
$('addDebt').onclick = () => {
  const party = prompt('Party name (who owes / owed to):','Client A');
  if(!party) return;
  const amt = safeNum(prompt('Amount','0'));
  const type = prompt('Type: "owed" (they owe you) or "owing" (you owe)','owed') === 'owed' ? 'owed' : 'owing';
  if(!amt || amt <= 0){ alert('Invalid amount'); return; }
  state.debts.push({ id: uid(), party, amount: amt, type });
  saveState();
};

$('addItemBtn').onclick = () => {
  const name = prompt('Item name','Tomato');
  if(!name) return;
  const qty = safeNum(prompt('Quantity','1'));
  const cost = safeNum(prompt('Unit cost','0'));
  state.inventory.push({ id: uid(), name, qty, cost });
  saveState();
};

// clear all
$('clearAll').onclick = () => {
  if(confirm('Clear ALL Book7 data? This cannot be undone.')) {
    state = { entries: [], debts: [], inventory: [], settings: { monthOffset: 0 } };
    saveState();
  }
};

// help
$('helpBtn').onclick = () => {
  alert('Book7 MVP help:\n- Add entries via Quick Entry.\n- Use Voice to dictate (try: "income 12000 sales client A").\n- Export JSON to backup and Import to restore.\n- Click calendar day to prefill date.');
};

// export/import
$('exportBtn').onclick = () => {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'book7-backup.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};
$('importBtn').onclick = () => $('fileInput').click();
$('fileInput').onchange = (ev) => {
  const f = ev.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const imported = JSON.parse(e.target.result);
      if(!confirm('Replace local data with imported file?')) return;
      state = imported;
      saveState();
      alert('Import complete');
    } catch(err){
      alert('Invalid JSON file');
    }
  };
  reader.readAsText(f);
};

// calendar day click prefill
$('calendarGrid').addEventListener('click', (ev) => {
  const dayEl = ev.target.closest('.day');
  if(!dayEl || !dayEl.dataset.date) return;
  const dateStr = dayEl.dataset.date;
  $('entryDate').value = dateStr;
  alert('Prefilled date: ' + dateStr + '. Now enter details and Add Entry.');
});

// month nav
$('prevMonth').onclick = () => { state.settings.monthOffset = (state.settings.monthOffset || 0) - 1; saveState(); };
$('nextMonth').onclick = () => { state.settings.monthOffset = (state.settings.monthOffset || 0) + 1; saveState(); };

// voice entry (if supported)
const recognitionAvailable = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
let recog;
if(recognitionAvailable){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recog = new SR();
  recog.lang = 'en-GB';
  recog.onresult = (e) => {
    const text = e.results[0][0].transcript;
    $('entryNote').value = text;
    parseVoiceToEntry(text);
  };
  recog.onerror = (err) => console.warn('voice err', err);
}
$('voiceBtn').onclick = () => {
  if(!recog){ alert('Speech not supported in this browser'); return; }
  try { recog.start(); } catch(e) { console.warn(e); }
};

// simple voice parser: looks for amount and keywords
function parseVoiceToEntry(text){
  const t = (text || '').toLowerCase();
  const amtMatch = t.match(/(\d+[.,]?\d{0,2})/);
  const type = t.includes('expense') || t.includes('buy') || t.includes('paid') ? 'expense' : (t.includes('income') || t.includes('sold') || t.includes('receive') ? 'income' : $('entryType').value);
  if(amtMatch) $('entryAmount').value = amtMatch[1].replace(',', '.');
  $('entryType').value = type;
  // category after 'for' or last word
  const catMatch = t.match(/(?:for|category|as)\s+([a-zA-Z]+)/);
  if(catMatch) $('entryCategory').value = catMatch[1];
  showAiTip();
}

// AI tips (local rules)
function showAiTip(){
  const formAmt = safeNum($('entryAmount').value);
  let tip = 'Tip: add category to track P&L by category.';
  if(formAmt > 100000) tip = 'Large amount detected â€” consider adding proof/invoice number.';
  else if(formAmt > 50000) tip = 'High-value entry â€” tag as "Capital" or "Investment" if applicable.';
  else {
    const cat = $('entryCategory').value.trim();
    if(cat){
      const recent = state.entries.filter(e => e.category && e.category.toLowerCase() === cat.toLowerCase());
      if(recent.length >= 3) tip = `You have ${recent.length} entries for "${cat}". Consider recurring label.`;
      else tip = `Tip: tagging "${cat}" helps P&L reporting.`;
    }
  }
  $('aiTip').textContent = tip;
}

// escape html
function escapeHtml(s){ if(s==null) return ''; return s.toString().replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

// init
function init(){
  loadState();
  if(!state.settings) state.settings = { monthOffset: 0 };
  if(!state.entries) state.entries = [];
  if(!state.debts) state.debts = [];
  if(!state.inventor