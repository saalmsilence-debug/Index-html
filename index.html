<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Book 7 Lite ‚Äî Ledger + Debt Manager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --accent:#0a7cff; --card:#fff; --bg:#f4f6f8; --muted:#666;
      --danger:#e74c3c; --success:#27ae60;
    }
    body{
      margin:0; padding:16px; font-family:Inter, system-ui, Arial;
      background:var(--bg); color:#111;
    }
    header{text-align:center; margin-bottom:12px;}
    h1{margin:0; font-size:20px}
    .card{
      background:var(--card); border-radius:10px; padding:14px;
      box-shadow:0 2px 6px rgba(0,0,0,0.06); margin-bottom:12px;
    }
    .balance{font-size:20px; font-weight:700; color:var(--accent); text-align:center;}
    label{display:block; font-weight:600; margin-top:8px; color:#222;}
    input, select, button, textarea{
      width:100%; padding:10px; margin-top:6px; box-sizing:border-box;
      border-radius:8px; border:1px solid #ddd; font-size:15px;
    }
    .row{display:flex; gap:10px;}
    .col{flex:1;}
    .small{font-size:13px; color:var(--muted);}
    button.primary{background:var(--accent); color:#fff; border:none; font-weight:700;}
    .ledger-list, .debt-list{list-style:none; margin:0; padding:0;}
    li.item{padding:12px 8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:flex-start;}
    .left{flex:1}
    .meta{color:var(--muted); font-size:13px; margin-top:6px}
    .btn{border-radius:6px; padding:6px 10px; border:1px solid #ddd; background:#fff; cursor:pointer;}
    .btn.danger{border-color:var(--danger); color:var(--danger); background:rgba(231,76,60,0.04)}
    .btn.success{border-color:var(--success); color:var(--success); background:rgba(39,174,96,0.04)}
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; margin-left:6px;}
    .badge.pending{background:#f0f5ff; color:var(--accent);}
    .badge.paid{background:rgba(39,174,96,0.12); color:var(--success);}
    .badge.partial{background:#fff7e6; color:#b17000;}
    .totals{display:flex; gap:10px; justify-content:space-between; margin-top:8px;}
    .totals .box{flex:1; text-align:center; padding:10px; border-radius:8px; background:#fbfdff; border:1px solid #eef6ff;}
    .controls{display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap;}
    .muted-line{color:var(--muted); font-size:13px; margin-top:6px;}
    .debt-actions{display:flex; gap:6px; margin-left:8px;}
    .history{font-size:13px; color:var(--muted); margin-top:6px;}
    .small-btn{font-size:13px; padding:6px 8px;}
    @media(min-width:720px){
      .row{flex-wrap:nowrap;}
      .col-half{flex:0 0 48%;}
    }
  </style>
</head>
<body>

<header>
  <h1>üìò Book 7 Lite MVP</h1>
  <div class="small muted-line">Ledger + Advanced Debt Manager</div>
</header>

<div class="card">
  <div class="balance">Balance: Ksh <span id="balance">0</span></div>
</div>

<!-- Add Transaction (Ledger) -->
<div class="card" id="add-transaction-card">
  <h3 style="margin:0 0 8px 0">‚ûï Add Transaction (Ledger)</h3>
  <div class="row">
    <div class="col">
      <label for="desc">Description</label>
      <input id="desc" placeholder="e.g., Sale, Rent" />
    </div>
    <div style="width:130px" class="col">
      <label for="amount">Amount</label>
      <input id="amount" type="number" placeholder="e.g., 5000" />
    </div>
  </div>
  <div class="row" style="margin-top:8px;">
    <div class="col">
      <label for="type">Type</label>
      <select id="type">
        <option value="income">Income</option>
        <option value="expense">Expense</option>
      </select>
    </div>
    <div style="width:160px">
      <label>&nbsp;</label>
      <button class="primary" onclick="addTransaction()">Save to Ledger</button>
    </div>
  </div>
</div>

<!-- Debt Manager -->
<div class="card">
  <h3 style="margin:0 0 8px 0">üè¶ Debt Manager (Advanced)</h3>

  <div class="controls">
    <div style="flex:1; min-width:160px;">
      <label for="debt-type">Debt Type</label>
      <select id="debt-type">
        <option value="owed">Owed to me</option>
        <option value="owe">I owe</option>
      </select>
    </div>
    <div style="width:120px;">
      <label for="debt-amount">Amount</label>
      <input id="debt-amount" type="number" placeholder="0" />
    </div>
    <div style="flex:1; min-width:160px;">
      <label for="debt-name">Name</label>
      <input id="debt-name" placeholder="Person or business" />
    </div>
  </div>

  <div class="row">
    <div class="col">
      <label for="debt-reason">Reason / Note</label>
      <input id="debt-reason" placeholder="e.g., goods sold, loan" />
    </div>
    <div style="width:160px">
      <label for="debt-due">Due Date</label>
      <input id="debt-due" type="date" />
    </div>
    <div style="width:160px">
      <label>&nbsp;</label>
      <button class="primary" onclick="addDebt()">Add Debt</button>
    </div>
  </div>

  <div class="totals" style="margin-top:12px;">
    <div class="box">
      <div class="small muted-line">Total Owed to Me</div>
      <div style="font-weight:800; font-size:18px; margin-top:6px;">Ksh <span id="total-owed">0</span></div>
    </div>
    <div class="box">
      <div class="small muted-line">Total I Owe</div>
      <div style="font-weight:800; font-size:18px; margin-top:6px;">Ksh <span id="total-owe">0</span></div>
    </div>
    <div class="box">
      <div class="small muted-line">Net Position</div>
      <div style="font-weight:800; font-size:18px; margin-top:6px;">Ksh <span id="net-pos">0</span></div>
    </div>
  </div>

  <div style="margin-top:12px;" class="controls">
    <div style="flex:1;">
      <label for="filter-type">Filter Type</label>
      <select id="filter-type" onchange="renderDebts()">
        <option value="all">All</option>
        <option value="owed">Owed to me</option>
        <option value="owe">I owe</option>
      </select>
    </div>
    <div style="width:160px;">
      <label for="filter-status">Filter Status</label>
      <select id="filter-status" onchange="renderDebts()">
        <option value="all">All</option>
        <option value="pending">Pending</option>
        <option value="partial">Partially Paid</option>
        <option value="paid">Paid</option>
        <option value="overdue">Overdue</option>
      </select>
    </div>
    <div style="width:160px;">
      <label for="sort-by">Sort By</label>
      <select id="sort-by" onchange="renderDebts()">
        <option value="newest">Newest</option>
        <option value="oldest">Oldest</option>
        <option value="due-asc">Due Date ‚Üë</option>
        <option value="due-desc">Due Date ‚Üì</option>
        <option value="amount-desc">Amount ‚Üì</option>
        <option value="amount-asc">Amount ‚Üë</option>
      </select>
    </div>
  </div>

</div>

<!-- Debts List -->
<div class="card">
  <h3 style="margin:0 0 8px 0">üìã Debts</h3>
  <ul id="debt-list" class="debt-list"></ul>
</div>

<!-- Ledger -->
<div class="card">
  <h3 style="margin:0 0 8px 0">üìò Ledger</h3>
  <ul id="list" class="ledger-list"></ul>
</div>

<!-- Debt history modal (simple) -->
<div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:10px; max-width:720px; width:94%; padding:16px; max-height:80vh; overflow:auto;" id="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 id="modal-title">History</h3>
      <button class="btn" onclick="closeModal()">Close</button>
    </div>
    <div id="modal-body"></div>
  </div>
</div>

<script>
/* -------------------------
  Storage & Structures
   - transactions: ledger entries
   - debts: advanced debt objects
---------------------------*/
let transactions = JSON.parse(localStorage.getItem('book7data')) || [];
let debts = JSON.parse(localStorage.getItem('book7-debts')) || [];

/* Utility: safe number parsing (digit-by-digit style care) */
function toNumber(v){
  const n = Number(v);
  if (Number.isFinite(n)) return Math.round(n*100)/100; // 2 decimals
  return 0;
}

/* Save */
function saveAll(){
  localStorage.setItem('book7data', JSON.stringify(transactions));
  localStorage.setItem('book7-debts', JSON.stringify(debts));
}

/* -------------------------
  Ledger functions (unchanged core)
---------------------------*/
function calculateBalance(){
  let balance = 0;
  transactions.forEach(t => {
    if (t.type === 'income') balance += toNumber(t.amount);
    else balance -= toNumber(t.amount);
  });
  document.getElementById('balance').innerText = balance.toFixed(2);
}
function renderList(){
  const list = document.getElementById('list');
  list.innerHTML = '';
  const sorted = [...transactions].sort((a,b)=> new Date(b.date) - new Date(a.date));
  sorted.forEach(t=>{
    const li = document.createElement('li');
    li.className='item';
    const left = document.createElement('div'); left.className='left';
    const prettyType = (t.type||'').toUpperCase();
    const prettyDate = t.date ? new Date(t.date).toLocaleString() : '‚Äî';
    left.innerHTML = `<strong>${prettyType}</strong> - ${escapeHtml(t.desc || '')}
      <div class="meta">Amount: Ksh ${Number(t.amount).toFixed(2)}<br><small>${prettyDate}</small></div>`;
    const actions = document.createElement('div');
    const del = document.createElement('button'); del.className='btn danger small-btn'; del.innerText='Delete';
    del.onclick = ()=>{ if(confirm('Delete this ledger entry?')){ transactions = transactions.filter(x=>x.id !== t.id); saveAll(); renderList(); calculateBalance(); } };
    actions.appendChild(del);
    li.appendChild(left); li.appendChild(actions);
    list.appendChild(li);
  });
}

/* Add transaction (ledger) */
function addTransaction(){
  const desc = document.getElementById('desc').value.trim();
  const amount = toNumber(document.getElementById('amount').value);
  const type = document.getElementById('type').value;
  if (!desc || !amount){ alert('Fill description and a valid amount'); return; }
  const obj = { id: 't-'+Date.now(), desc, amount, type, date:new Date().toISOString() };
  transactions.push(obj); saveAll(); renderList(); calculateBalance();
  document.getElementById('desc').value=''; document.getElementById('amount').value='';
}

/* -------------------------
  Debt Manager functions
---------------------------*/
function computeDebtStatus(d){
  // d structure: { id, type('owed'|'owe'), name, amount, remaining, reason, due, history: [{amt,date,note,ledger}], created }
  const today = new Date();
  const remaining = toNumber(d.remaining);
  if (remaining <= 0) return 'paid';
  if (d.due){
    const dueDate = new Date(d.due);
    if (dueDate < today && remaining > 0) return 'overdue';
  }
  // partial if some payments exist but remaining > 0
  if ((d.history && d.history.length>0) && remaining>0) return 'partial';
  return 'pending';
}

function addDebt(){
  const type = document.getElementById('debt-type').value; // owed | owe
  const amount = toNumber(document.getElementById('debt-amount').value);
  const name = document.getElementById('debt-name').value.trim();
  const reason = document.getElementById('debt-reason').value.trim();
  const due = document.getElementById('debt-due').value || null;
  if (!name || !amount){ alert('Enter name and amount'); return; }
  const obj = {
    id: 'd-'+Date.now(),
    type,
    name,
    amount,
    remaining: amount,
    reason,
    due,
    history: [],
    created: new Date().toISOString()
  };
  debts.push(obj); saveAll(); renderDebts(); renderList(); calculateBalance();
  document.getElementById('debt-name').value=''; document.getElementById('debt-amount').value=''; document.getElementById('debt-reason').value=''; document.getElementById('debt-due').value='';
}

/* Render debts */
function renderDebts(){
  const list = document.getElementById('debt-list');
  list.innerHTML='';
  // filters
  const fType = document.getElementById('filter-type').value;
  const fStatus = document.getElementById('filter-status').value;
  const sortBy = document.getElementById('sort-by').value;

  let shown = debts.map(d=>{
    d.status = computeDebtStatus(d);
    return d;
  });

  if (fType !== 'all') shown = shown.filter(s=>s.type === fType);
  if (fStatus !== 'all') shown = shown.filter(s=>s.status === fStatus);

  // sort
  shown.sort((a,b)=>{
    if (sortBy==='newest') return new Date(b.created) - new Date(a.created);
    if (sortBy==='oldest') return new Date(a.created) - new Date(b.created);
    if (sortBy==='due-asc') return (a.due?new Date(a.due):0) - (b.due?new Date(b.due):0);
    if (sortBy==='due-desc') return (b.due?new Date(b.due):0) - (a.due?new Date(a.due):0);
    if (sortBy==='amount-desc') return b.remaining - a.remaining;
    if (sortBy==='amount-asc') return a.remaining - b.remaining;
    return 0;
  });

  // totals
  let totalOwed=0, totalOwe=0;
  debts.forEach(d=>{
    if (d.type ==='owed') totalOwed += toNumber(d.remaining);
    else totalOwe += toNumber(d.remaining);
  });
  document.getElementById('total-owed').innerText = totalOwed.toFixed(2);
  document.getElementById('total-owe').innerText = totalOwe.toFixed(2);
  document.getElementById('net-pos').innerText = (totalOwed - totalOwe).toFixed(2);

  shown.forEach(d=>{
    const li = document.createElement('li'); li.className='item';
    const left = document.createElement('div'); left.className='left';
    const title = document.createElement('div');
    title.innerHTML = `<strong>${d.type==='owed' ? 'INCOMING (Owed to me)' : 'OUTGOING (I owe)'}</strong> - ${escapeHtml(d.name)}
      <span class="badge ${d.status==='pending'?'pending':d.status==='paid'?'paid':'partial'}">${capitalize(d.status)}</span>`;
    const meta = document.createElement('div');
    meta.className='meta';
    const dueText = d.due ? (new Date(d.due)).toLocaleDateString() : 'No due date';
    meta.innerHTML = `Amount: Ksh ${Number(d.amount).toFixed(2)}<br>
      Remaining: Ksh ${Number(d.remaining).toFixed(2)}<br>
      Due: ${dueText}<br><small>${escapeHtml(d.reason || '')}</small>`;
    left.appendChild(title); left.appendChild(meta);

    const actions = document.createElement('div');
    actions.className='debt-actions';
    // View history
    const viewBtn = document.createElement('button'); viewBtn.className='btn small-btn'; viewBtn.innerText='History';
    viewBtn.onclick = ()=> openHistory(d.id);
    actions.appendChild(viewBtn);
    // Record payment button
    const payBtn = document.createElement('button'); payBtn.className='btn success small-btn'; payBtn.innerText='Record Payment';
    payBtn.onclick = ()=> promptPayment(d.id);
    actions.appendChild(payBtn);
    // Quick mark paid (asks)
    const markBtn = document.createElement('button'); markBtn.className='btn small-btn'; markBtn.innerText='Mark Paid';
    markBtn.onclick = ()=> markAsPaid(d.id);
    actions.appendChild(markBtn);
    // Delete
    const delBtn = document.createElement('button'); delBtn.className='btn danger small-btn'; delBtn.innerText='Delete';
    delBtn.onclick = ()=> { if(confirm('Delete this debt and history?')){ debts = debts.filter(x=>x.id !== d.id); saveAll(); renderDebts(); } };
    actions.appendChild(delBtn);

    li.appendChild(left); li.appendChild(actions);
    list.appendChild(li);
  });
}

/* Payment flow */
function promptPayment(debtId){
  const d = debts.find(x=>x.id===debtId); if(!d) return alert('Debt not found');
  const pay = prompt(`Enter payment amount for "${d.name}" (Remaining Ksh ${Number(d.remaining).toFixed(2)})`);
  if (pay === null) return;
  const amt = toNumber(pay);
  if (!amt || amt <= 0) return alert('Enter a valid amount');
  if (amt > d.remaining) {
    if (!confirm('Payment exceeds remaining amount. Record anyway and create credit?')) return;
  }
  const note = prompt('Optional note for this payment (e.g., MPesa Txn, cash)');
  // Option: ask to also log into ledger
  const logToLedger = confirm('Also record this payment into the Ledger? (Choose OK for yes)');
  recordPayment(d.id, amt, note || '', logToLedger);
}

function recordPayment(debtId, amount, note, logToLedger){
  const d = debts.find(x=>x.id===debtId); if(!d) return;
  // reduce remaining
  d.remaining = toNumber(d.remaining - amount);
  if (d.remaining < 0) {
    // create credit record in history
    d.history.push({ amt: amount, date: new Date().toISOString(), note: note || 'Overpayment' });
    // keep remaining as 0 for debt
    d.remaining = 0;
  } else {
    d.history.push({ amt: amount, date: new Date().toISOString(), note: note || '' });
  }
  // if user asked to log in ledger
  if (logToLedger){
    // if debt.type === 'owed' then recording a payment means someone paid you => income
    // if debt.type === 'owe' then you paid someone => expense
    const ledgerType = d.type === 'owed' ? 'income' : 'expense';
    const t = {
      id: 't-'+Date.now(),
      desc: `${d.type==='owed'?'Payment received from':'Payment to'} ${d.name} (${note || 'debt payment'})`,
      amount: amount,
      type: ledgerType,
      date: new Date().toISOString()
    };
    transactions.push(t);
  }
  // update status
  d.status = computeDebtStatus(d);
  saveAll();
  renderDebts();
  renderList();
  calculateBalance();
}

/* Mark fully paid */
function markAsPaid(debtId){
  const d = debts.find(x=>x.id===debtId); if(!d) return;
  if (!confirm('Mark this debt as fully paid and add remaining amount as payment?')) return;
  const amount = toNumber(d.remaining);
  if (amount >0){
    // record payment without asking ledger logging; ask user
    const logToLedger = confirm('Record final payment into ledger? OK=yes');
    recordPayment(debtId, amount, 'Marked paid', logToLedger);
  } else {
    d.remaining =0; d.status = 'paid'; saveAll(); renderDebts();
  }
}

/* View history modal */
function openHistory(debtId){
  const d = debts.find(x=>x.id===debtId); if(!d) return;
  const body = document.getElementById('modal-body');
  document.getElementById('modal-title').innerText = `History ‚Äî ${d.name}`;
  let html = `<div><strong>Original Amount:</strong> Ksh ${Number(d.amount).toFixed(2)}</div>
    <div><strong>Remaining:</strong> Ksh ${Number(d.remaining).toFixed(2)}</div>
    <div class="small muted-line">Reason: ${escapeHtml(d.reason || '')}</div>
    <div class="small muted-line">Created: ${new Date(d.created).toLocaleString()}</div>
    <hr/>`;
  if (d.history.length === 0) html += `<div class="small muted-line">No payments recorded</div>`;
  else {
    html += '<ul style="padding-left:0; list-style:none;">';
    d.history.slice().reverse().forEach(h=>{
      html += `<li style="padding:8px 0; border-bottom:1px solid #f0f0f0;">
        <div><strong>Ksh ${Number(h.amt).toFixed(2)}</strong> <small style="color:#666">- ${new Date(h.date).toLocaleString()}</small></div>
        <div class="history">${escapeHtml(h.note || '')}</div>
      </li>`;
    });
    html += '</ul>';
  }
  // quick actions inside modal
  html += `<hr/><div style="display:flex; gap:8px; flex-wrap:wrap;">
    <button class="btn primary" onclick="promptPayment('${d.id}')">Record Payment</button>
    <button class="btn" onclick="downloadDebt('${d.id}')">Download (.json)</button>
    <button class="btn danger" onclick="deleteDebtFromModal('${d.id}')">Delete Debt</button>
  </div>`;
  body.innerHTML = html;
  document.getElementById('modal').style.display='flex';
}
function closeModal(){ document.getElementById('modal').style.display='none'; }

/* Delete from modal */
function deleteDebtFromModal(id){
  if (!confirm('Delete this debt permanently?')) return;
  debts = debts.filter(x=>x.id!==id); saveAll(); renderDebts(); closeModal();
}

/* Download debt JSON */
function downloadDebt(id){
  const d = debts.find(x=>x.id===id); if (!d) return alert('Not found');
  const blob = new Blob([JSON.stringify(d, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
 