<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Book 7 Ledger MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f7f9;
      margin: 0;
      padding: 10px;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    h1 { text-align: center; color: #1e3a8a; margin-bottom: 5px; }
    .tabs { display: flex; margin-bottom: 15px; border-radius: 8px; overflow: hidden; }
    .tabs button {
      flex-grow: 1;
      padding: 12px 10px;
      border: none;
      background: #e0e7ff;
      cursor: pointer;
      font-weight: bold;
      color: #3b82f6;
      transition: background 0.3s;
    }
    .tabs button.active {
      background: #1e3a8a;
      color: white;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    .section { display: none; margin-top: 10px; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; }
    .section.active { display: block; }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    button.primary-btn {
      background: #10b981;
      color: white;
      padding: 12px;
      width: 100%;
      border-radius: 10px;
      border: none;
      font-weight: bold;
      margin-top: 10px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button.primary-btn:hover { background: #059669; }

    .card {
      background: #f9fafb;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 5px solid #3b82f6;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .card.inflow { border-left-color: #10b981; }
    .card.outflow { border-left-color: #ef4444; }
    .card.debt-owe { border-left-color: #f59e0b; }
    .card.debt-receive { border-left-color: #3b82f6; }
    .card.overdue { background: #fee2e2; border-left-color: #dc2626; }
    .pnl-box { padding: 10px; margin: 5px 0; border-radius: 8px; font-weight: bold; }
    .pnl-revenue { background: #d1fae5; color: #065f46; }
    .pnl-expense { background: #fee2e2; color: #991b1b; }
    .pnl-net { background: #e0e7ff; color: #1e3a8a; font-size: 1.2em; }
  </style>
</head>

<body>

<div class="container">
  <h1>Book 7 Ledger MVP</h1>
  <p style="text-align:center;font-size:12px;color:#666;">Local Storage Persistence</p>

  <div class="tabs">
    <button class="tab active" onclick="showTab('journal')">1. Journal / Ledger</button>
    <button class="tab" onclick="showTab('pnl')">2. P&L Tracking</button>
    <button class="tab" onclick="showTab('calendar')">3. Calendar / Debts</button>
    <button class="tab" onclick="showTab('ai-summary')">4. AI Analysis</button>
  </div>

  <div id="journal" class="section active">
    <h3>New Entry (Journal)</h3>
    <input type="date" id="tDate" value=""/>
    <select id="tCategory">
      <option value="Sale">Sale (Revenue)</option>
      <option value="Rent">Rent (Expense)</option>
      <option value="Salary">Salary/Wages (Expense)</option>
      <option value="Inventory">Inventory/Stock (Outflow)</option>
      <option value="Utility">Utility Bills (Expense)</option>
      <option value="OtherIncome">Other Income</option>
      <option value="OtherExpense">Other Expense</option>
    </select>
    <input type="number" id="tInflow" placeholder="Inflow (Ksh) - Enter only if money came IN"/>
    <input type="number" id="tOutflow" placeholder="Outflow (Ksh) - Enter only if money went OUT"/>
    <textarea id="tDesc" placeholder="Description (e.g., 'Coffee beans purchase from XYZ')" rows="2"></textarea>

    <button class="primary-btn" onclick="addTransaction()">Save Entry</button>

    <h3 style="margin-top: 20px;">Recent Ledger Entries</h3>
    <div id="transactionsList" class="space-y-3"></div>
  </div>

  <div id="pnl" class="section">
    <h3>Profit & Loss Report (All Time)</h3>
    <div class="pnl-box pnl-revenue">Total Revenue: Ksh <span id="totalRevenue">0</span></div>
    <div class="pnl-box pnl-expense">Total Expenses: Ksh <span id="totalExpense">0</span></div>
    <div class="pnl-box pnl-net">Net Profit (Loss): Ksh <span id="netProfit">0</span></div>

    <h3 style="margin-top: 20px;">Debt Summary</h3>
    <div class="pnl-box" style="background: #fff3cd; color: #856404;">Total Owed to Others: Ksh <span id="totalOwed">0</span></div>
    <div class="pnl-box" style="background: #cce5ff; color: #004085;">Total Receivable: Ksh <span id="totalReceive">0</span></div>
  </div>

  <div id="calendar" class="section">
    <h3>New Debt / Receivable</h3>
    <select id="dType">
        <option value="owe">Debt I Owe (Payable)</option>
        <option value="receive">Debt Owed To Me (Receivable)</option>
    </select>
    <input type="text" id="dName" placeholder="Name / Contact"/>
    <input type="number" id="dAmount" placeholder="Amount (Ksh)"/>
    <input type="date" id="dDate"/>

    <button class="primary-btn" onclick="addDebt()">Add Debt/Receivable</button>

    <h3 style="margin-top: 20px;">Upcoming Obligations (Calendar)</h3>
    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Click to mark as settled.</p>
    <div id="debtsList"></div>
  </div>

  <div id="ai-summary" class="section">
    <h3>Actionable Insights (Simulated)</h3>
    <p>Since this is a GitHub Pages MVP without a secure backend, this section provides **Simulated AI Insights** based on your current Net Profit/Loss.</p>
    <div class="card" id="aiInsightCard" style="border-left-color: #8b5cf6;">
        <p style="font-weight: normal; font-style: italic;">Load the P&L tab first to generate the insights.</p>
    </div>
    
    <h3 style="margin-top: 20px;">Actionable Steps</h3>
    <ul style="list-style: disc; padding-left: 20px; font-size: 0.9em;">
        <li>**Profit Leak Analysis:** Check your largest expense categories in the ledger.</li>
        <li>**Strategic Growth Idea:** Focus on settling high-value receivables (Debts Owed To You).</li>
        <li>**Security Note:** For true AI analysis (like Gemini), a secure server-side setup is required.</li>
    </ul>
  </div>

</div>

<script>
// --- GLOBAL DATA & PERSISTENCE ---
let transactions = [];
let debts = [];
const STORAGE_KEY = 'book7_ledger_data';

/**
 * Loads data from Local Storage or initializes if empty.
 */
function loadData() {
  const data = localStorage.getItem(STORAGE_KEY);
  if (data) {
    const parsed = JSON.parse(data);
    transactions = parsed.transactions || [];
    debts = parsed.debts || [];
  }
}

/**
 * Saves current data arrays to Local Storage.
 */
function saveData() {
  const dataToSave = {
    transactions: transactions,
    debts: debts
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
  // Re-render and recalculate after every save
  renderTransactions();
  renderDebts();
  calculatePnl();
  generateAiInsight();
}


// --- NAVIGATION ---
function showTab(tabId) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
  
  document.getElementById(tabId).classList.add('active');
  document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
  
  // Recalculate P&L and AI insight whenever P&L or AI tab is opened
  if (tabId === 'pnl' || tabId === 'ai-summary') {
    calculatePnl();
    generateAiInsight();
  }
}


// --- 1. JOURNAL / LEDGER LOGIC ---
function addTransaction() {
  const dateVal = document.getElementById('tDate').value;
  const categoryVal = document.getElementById('tCategory').value;
  const inflowVal = parseFloat(document.getElementById('tInflow').value) || 0;
  const outflowVal = parseFloat(document.getElementById('tOutflow').value) || 0;
  const descVal = document.getElementById('tDesc').value;

  if (!dateVal || (!inflowVal && !outflowVal)) {
    alert("Please enter a Date and either an Inflow or an Outflow amount.");
    return;
  }
  
  // Ensure only one of inflow or outflow is recorded
  if (inflowVal > 0 && outflowVal > 0) {
    alert("Please record as either Inflow OR Outflow, not both.");
    return;
  }

  const t = {
    date: dateVal,
    category: categoryVal,
    inflow: inflowVal,
    outflow: outflowVal,
    desc: descVal,
    id: Date.now() // Simple unique ID
  };
  
  transactions.unshift(t); // Add to the start for "Recent" view
  
  // Clear form fields
  document.getElementById('tInflow').value = '';
  document.getElementById('tOutflow').value = '';
  document.getElementById('tDesc').value = '';
  
  saveData();
}

function renderTransactions() {
  const listDiv = document.getElementById('transactionsList');
  listDiv.innerHTML = "";

  transactions.slice(0, 10).forEach(t => { // Show max 10 recent transactions
    const amount = t.inflow || t.outflow;
    const type = t.inflow > 0 ? 'Inflow' : 'Outflow';
    const sign = t.inflow > 0 ? '+' : '-';
    const cardClass = t.inflow > 0 ? 'inflow' : 'outflow';

    listDiv.innerHTML += `
      <div class="card ${cardClass}">
        <div style="font-size: 0.8em; color: #666;">${t.date} (${t.category})</div>
        <p style="margin: 0; font-weight: bold;">${t.desc || 'No Description'}</p>
        <span style="float: right; font-weight: bold; color: ${t.inflow > 0 ? '#10b981' : '#ef4444'};">
          ${sign}Ksh ${amount.toLocaleString()}
        </span>
      </div>`;
  });
  if (transactions.length === 0) {
    listDiv.innerHTML = '<p style="text-align: center; color: #999; font-style: italic;">No entries yet. Start logging above!</p>';
  }
}


// --- 2. P&L LOGIC ---
function calculatePnl() {
  // P&L Tracking
  let totalRevenue = 0;
  let totalExpense = 0;
  
  transactions.forEach(t => {
    // Basic P&L categorization based on simplified categories
    if (t.inflow > 0 && (t.category === 'Sale' || t.category === 'OtherIncome')) {
      totalRevenue += t.inflow;
    } else if (t.outflow > 0 && (t.category === 'Rent' || t.category === 'Salary' || t.category === 'Utility' || t.category === 'OtherExpense')) {
      totalExpense += t.outflow;
    }
    // Note: Inventory purchase is treated as a simple outflow here, not COGS calculation for MVP simplicity.
  });

  const netProfit = totalRevenue - totalExpense;

  document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString();
  document.getElementById('totalExpense').textContent = totalExpense.toLocaleString();
  document.getElementById('netProfit').textContent = netProfit.toLocaleString();
  document.getElementById('netProfit').parentElement.style.backgroundColor = netProfit >= 0 ? '#e0f2f1' : '#fce7f6';
  document.getElementById('netProfit').parentElement.style.color = netProfit >= 0 ? '#0d9488' : '#e91e63';

  // Debt Summary
  const totalOwed = debts.filter(d => d.type === 'owe' && !d.isSettled).reduce((sum, d) => sum + d.amount, 0);
  const totalReceive = debts.filter(d => d.type === 'receive' && !d.isSettled).reduce((sum, d) => sum + d.amount, 0);

  document.getElementById('totalOwed').textContent = totalOwed.toLocaleString();
  document.getElementById('totalReceive').textContent = totalReceive.toLocaleString();
}


// --- 3. CALENDAR / DEBT LOGIC ---
function addDebt() {
  const typeVal = document.getElementById('dType').value;
  const nameVal = document.getElementById('dName').value;
  const amountVal = parseFloat(document.getElementById('dAmount').value) || 0;
  const dateVal = document.getElementById('dDate').value;

  if (!nameVal || !amountVal || !dateVal) {
    alert("Please fill in all debt fields.");
    return;
  }

  debts.push({
    name: nameVal,
    amount: amountVal,
    dueDate: dateVal,
    type: typeVal,
    isSettled: false,
    id: Date.now()
  });

  // Clear form fields
  document.getElementById('dName').value = '';
  document.getElementById('dAmount').value = '';
  document.getElementById('dDate').value = '';

  saveData();
}

function toggleDebtSettled(id) {
    const debtIndex = debts.findIndex(d => d.id === id);
    if (debtIndex !== -1) {
        debts[debtIndex].isSettled = !debts[debtIndex].isSettled;
        saveData();
    }
}

function renderDebts() {
  const listDiv = document.getElementById('debtsList');
  listDiv.innerHTML = "";

  // Sort debts: Unsettled first, then by earliest due date
  const sortedDebts = debts.slice().sort((a, b) => {
    if (a.isSettled !== b.isSettled) {
        return a.isSettled ? 1 : -1;
    }
    return new Date(a.dueDate) - new Date(b.dueDate);
  });

  const today = new Date().toISOString().substring(0, 10);

  sortedDebts.forEach(d => {
    const isOverdue = !d.isSettled && d.dueDate < today;
    const cardClass = d.type === 'owe' ? 'debt-owe' : 'debt-receive';
    const statusText = d.isSettled ? 'Settled' : (isOverdue ? 'OVERDUE' : 'Pending');
    const statusColor = d.isSettled ? '#047857' : (isOverdue ? '#dc2626' : '#9333ea');
    const finalClass = isOverdue ? 'overdue' : cardClass;

    listDiv.innerHTML += `
      <div class="card ${finalClass}" onclick="toggleDebtSettled(${d.id})">
        <div style="font-size: 0.9em; font-weight: bold;">${d.name} (${d.type === 'owe' ? 'I OWE' : 'RECEIVE'})</div>
        <p style="margin: 3px 0; font-size: 1.1em; float: right; font-weight: bold;">Ksh ${d.amount.toLocaleString()}</p>
        <div style="font-size: 0.8em; color: ${statusColor};">
          Due: ${d.dueDate} - **${statusText}**
        </div>
      </div>`;
  });

  if (debts.length === 0) {
    listDiv.innerHTML = '<p style="text-align: center; color: #999; font-style: italic;">No debts recorded.</p>';
  }
}


// --- 4. AI ANALYSIS LOGIC ---
function generateAiInsight() {
    const totalRev = parseFloat(document.getElementById('totalRevenue').textContent.replace(/,/g, '')) || 0;
    const totalExp = parseFloat(document.getElementById('totalExpense').textContent.replace(/,/g, '')) || 0;
    const net = totalRev - totalExp;
    const card = document.getElementById('aiInsightCard');
    
    let insightText = '';
    let insightColor = '#1e3a8a';

    if (transactions.length === 0) {
        insightText = "**START NOW:** Input transactions to see your financial health analysis!";
        insightColor = '#6b7280';
    } else if (net > 5000) {
        insightText = `**STRATEGIC GROWTH:** Net Profit of Ksh ${net.toLocaleString()} is strong. Focus on reinvesting Ksh ${Math.round(net * 0.2).toLocaleString()} into marketing or new inventory to scale operations.`;
        insightColor = '#10b981';
    } else if (net >= 0 && net <= 5000) {
        insightText = `**CASH FLOW FOCUS:** Net Profit is narrow (Ksh ${net.toLocaleString()}). Analyze the Ledger for small, recurring expenses that can be cut. Optimize pricing.`;
        insightColor = '#f59e0b';
    } else {
        insightText = `**CRITICAL LEAK:** Your business is currently running at a Net Loss of Ksh ${net.toLocaleString() * -1}. **Immediately** review your largest **Outflows** to identify non-essential spending.`;
        insightColor = '#ef4444';
    }

    card.innerHTML = `<p style="font-weight: bold;">AI Insight:</p><p style="margin: 0;">${insightText}</p>`;
    card.style.borderLeftColor = insightColor;
}


// --- INITIALIZATION ---
window.onload = function() {
  // Set today's date in the date picker
  document.getElementById('tDate').value = new Date().toISOString().substring(0, 10);
  document.getElementById('dDate').value = new Date().toISOString().substring(0, 10);
  
  loadData();
  saveData(); // This triggers the initial render and P&L calculation
};
</script>

</body>
  </html>
